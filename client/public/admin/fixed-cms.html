<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS - Groupe Tonic</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <header class="bg-white shadow-sm border-b">
        <div class="px-6 py-4">
            <h1 class="text-2xl font-bold">Content Management System</h1>
        </div>
        <nav class="flex px-6 py-3 space-x-4 bg-gray-50">
            <button onclick="switchToJobs()" id="jobsBtn" class="px-4 py-2 rounded font-medium bg-blue-500 text-white">
                Jobs
            </button>
            <button onclick="switchToNews()" id="newsBtn" class="px-4 py-2 rounded font-medium text-gray-600">
                News
            </button>
            <select id="lang" onchange="loadData()" class="ml-auto px-4 py-2 border rounded">
                <option value="fr">Français</option>
                <option value="en">English</option>
            </select>
        </nav>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Department Filter - Always visible, controlled by JavaScript -->
        <div id="deptFilter" style="display: none;" class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Department:</label>
            <select id="deptSelect" onchange="filterByDept()" class="p-2 border rounded">
                <option value="">All Departments</option>
                <option value="Administration">Administration</option>
                <option value="Événements">Événements</option>
                <option value="Marketing">Marketing</option>
                <option value="Production">Production</option>
                <option value="Groupe Tonic">Groupe Tonic</option>
            </select>
        </div>
        
        <div id="content"></div>
    </main>

    <script>
        const token = localStorage.getItem('cmsToken');
        if (!token) window.location.href = '/admin/';
        
        let currentType = 'jobs';
        let allData = [];
        
        function switchToJobs() {
            currentType = 'jobs';
            document.getElementById('jobsBtn').className = 'px-4 py-2 rounded font-medium bg-blue-500 text-white';
            document.getElementById('newsBtn').className = 'px-4 py-2 rounded font-medium text-gray-600';
            document.getElementById('deptFilter').style.display = 'none';
            loadData();
        }
        
        function switchToNews() {
            currentType = 'news';
            document.getElementById('newsBtn').className = 'px-4 py-2 rounded font-medium bg-blue-500 text-white';
            document.getElementById('jobsBtn').className = 'px-4 py-2 rounded font-medium text-gray-600';
            document.getElementById('deptFilter').style.display = 'block';
            loadData();
        }
        
        async function loadData() {
            const lang = document.getElementById('lang').value;
            const endpoint = currentType === 'jobs' ? 
                `/api/cms/jobs?lang=${lang}` : 
                `/api/cms/news?lang=${lang}`;
                
            try {
                const response = await fetch(endpoint, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load');
                
                const data = await response.json();
                allData = currentType === 'jobs' ? data.jobs : data.news;
                
                console.log(`Loaded ${allData.length} ${currentType} in ${lang}`);
                displayData(allData);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('content').innerHTML = '<p class="text-red-500">Error loading data</p>';
            }
        }
        
        function displayData(items) {
            const content = document.getElementById('content');
            
            if (!items || items.length === 0) {
                content.innerHTML = '<p class="text-gray-500">No content available</p>';
                return;
            }
            
            content.innerHTML = items.map(item => `
                <div class="bg-white p-4 rounded shadow mb-4">
                    <h3 class="font-bold">${item.title || item.newsTitle}</h3>
                    <p class="text-gray-600 text-sm">
                        ${currentType === 'jobs' ? 
                            `${item.department || ''} • ${item.location || ''}` : 
                            `${item.department || item.category || ''} • ${item.date || ''}`}
                    </p>
                    <div class="mt-2">
                        <button onclick="editItem(${item.id})" class="text-blue-600 mr-4">Edit</button>
                        <button onclick="deleteItem(${item.id})" class="text-red-600">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function filterByDept() {
            const dept = document.getElementById('deptSelect').value;
            if (!dept) {
                displayData(allData);
            } else {
                const filtered = allData.filter(item => item.department === dept);
                displayData(filtered);
            }
        }
        
        async function editItem(id) {
            const item = allData.find(i => i.id === id);
            if (!item) return;
            
            alert(`Edit functionality: ${item.title || item.newsTitle}`);
        }
        
        async function deleteItem(id) {
            if (!confirm('Delete this item?')) return;
            
            const lang = document.getElementById('lang').value;
            const endpoint = currentType === 'jobs' ? 
                `/api/cms/jobs/${id}?lang=${lang}` : 
                `/api/cms/news/${id}?lang=${lang}`;
                
            try {
                const response = await fetch(endpoint, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    loadData();
                }
            } catch (error) {
                console.error('Delete error:', error);
            }
        }
        
        // Initial load
        loadData();
    </script>
</body>
</html>