<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-6xl">
            <h1 class="text-2xl font-bold mb-6 text-center">CMS Final</h1>
            
            <div id="loginForm" class="mb-6">
                <input type="text" id="username" placeholder="admin" class="w-full p-3 border rounded mb-3">
                <input type="password" id="password" placeholder="admin123" class="w-full p-3 border rounded mb-3">
                <button onclick="login()" class="w-full bg-blue-500 text-white p-3 rounded">Login</button>
                <div id="error" class="text-red-500 mt-2 hidden"></div>
            </div>

            <div id="dashboard" class="hidden">
                <div class="flex mb-6 items-center gap-4">
                    <button onclick="showJobs()" class="px-4 py-2 rounded" id="jobsBtn">Jobs</button>
                    <button onclick="showNews()" class="px-4 py-2 rounded" id="newsBtn">News</button>
                    
                    <select id="langSelect" class="border p-2 rounded">
                        <option value="fr">Fran√ßais</option>
                        <option value="en">English</option>
                    </select>
                    <button onclick="changeLanguage()" class="bg-purple-500 text-white px-4 py-2 rounded">Switch Language</button>
                    
                    <div class="ml-auto flex gap-2">
                        <button onclick="addContent()" class="bg-green-500 text-white px-4 py-2 rounded" id="addBtn">Add</button>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
                    </div>
                </div>

                <div id="currentLang" class="text-sm text-gray-600 mb-4">Current: French</div>
                <div id="content"></div>
            </div>
        </div>
    </div>

    <script>
        let token = null;
        let currentLang = 'fr';
        let currentView = 'jobs';
        let currentData = [];

        async function login() {
            const username = document.getElementById('username').value || 'admin';
            const password = document.getElementById('password').value || 'admin123';

            try {
                const response = await fetch('/api/cms/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    token = data.token;
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    await loadContent();
                } else {
                    showError('Login failed');
                }
            } catch (error) {
                showError('Connection error');
            }
        }

        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').classList.remove('hidden');
        }

        function logout() {
            token = null;
            currentData = [];
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        function showJobs() {
            currentView = 'jobs';
            updateUI();
            renderContent();
        }

        function showNews() {
            currentView = 'news';
            updateUI();
            renderContent();
        }

        function updateUI() {
            // Update buttons
            document.getElementById('jobsBtn').className = currentView === 'jobs' 
                ? 'px-4 py-2 rounded bg-blue-600 text-white' 
                : 'px-4 py-2 rounded bg-gray-200 text-gray-700';
            document.getElementById('newsBtn').className = currentView === 'news' 
                ? 'px-4 py-2 rounded bg-green-600 text-white' 
                : 'px-4 py-2 rounded bg-gray-200 text-gray-700';
            
            // Update add button
            document.getElementById('addBtn').textContent = currentView === 'jobs' ? 'Add Job' : 'Add News';
            
            // Update language display
            document.getElementById('currentLang').textContent = `Current: ${currentLang === 'fr' ? 'French' : 'English'}`;
            document.getElementById('langSelect').value = currentLang;
        }

        async function changeLanguage() {
            const newLang = document.getElementById('langSelect').value;
            console.log('Changing language from', currentLang, 'to', newLang);
            currentLang = newLang;
            updateUI();
            await loadContent();
        }

        async function loadContent() {
            try {
                console.log('Loading', currentView, 'for language', currentLang);
                
                const endpoint = currentView === 'jobs' ? '/api/cms/jobs' : '/api/cms/news';
                const response = await fetch(`${endpoint}?lang=${currentLang}&_t=${Date.now()}`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentData = currentView === 'jobs' ? data.jobs : data.news;
                    console.log('Loaded', currentData.length, 'items:', currentData);
                    renderContent();
                } else {
                    document.getElementById('content').innerHTML = '<div class="text-red-500">Failed to load content</div>';
                }
            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('content').innerHTML = '<div class="text-red-500">Error loading content</div>';
            }
        }

        function renderContent() {
            let html = '';
            
            if (currentData.length === 0) {
                html = `<div class="text-gray-500 text-center py-8">No ${currentView} found for ${currentLang === 'fr' ? 'French' : 'English'}</div>`;
            } else {
                html = '<div class="space-y-4">';
                currentData.forEach(item => {
                    if (currentView === 'jobs') {
                        html += renderJobCard(item);
                    } else {
                        html += renderNewsCard(item);
                    }
                });
                html += '</div>';
            }
            
            document.getElementById('content').innerHTML = html;
        }

        function renderJobCard(job) {
            const description = job.description || job.summary || job.content || 'No description available';
            
            return `
                <div class="border rounded-lg p-6 bg-white shadow-sm">
                    <h3 class="text-xl font-bold text-blue-600 mb-3">${escapeHtml(job.title || 'No title')}</h3>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4 text-sm">
                        <div><strong>Department:</strong> ${escapeHtml(job.department || 'N/A')}</div>
                        <div><strong>Location:</strong> ${escapeHtml(job.location || job.lieu || 'N/A')}</div>
                        <div><strong>Type:</strong> ${escapeHtml(job.type || 'N/A')}</div>
                        <div><strong>Salary:</strong> ${escapeHtml(job.salary || job.salaire || 'N/A')}</div>
                        <div><strong>Posted:</strong> ${escapeHtml(job.datePosted || 'N/A')}</div>
                        <div><strong>Deadline:</strong> ${escapeHtml(job.deadline || 'N/A')}</div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded border-l-4 border-blue-500 mb-4">
                        <h4 class="font-semibold mb-2">Full Description:</h4>
                        <div class="text-sm leading-relaxed whitespace-pre-wrap">${escapeHtml(description)}</div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="editItem(${job.id})" class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600">Edit</button>
                        <button onclick="deleteItem(${job.id})" class="bg-red-500 text-white px-4 py-2 rounded text-sm hover:bg-red-600">Delete</button>
                    </div>
                </div>
            `;
        }

        function renderNewsCard(article) {
            const description = article.description || article.summary || article.content || 'No content available';
            
            return `
                <div class="border rounded-lg p-6 bg-white shadow-sm">
                    <h3 class="text-xl font-bold text-green-600 mb-3">${escapeHtml(article.title || 'No title')}</h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                        <div><strong>Date:</strong> ${escapeHtml(article.date || 'N/A')}</div>
                        <div><strong>Category:</strong> ${escapeHtml(article.category || article.section || 'N/A')}</div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded border-l-4 border-green-500 mb-4">
                        <h4 class="font-semibold mb-2">Full Content:</h4>
                        <div class="text-sm leading-relaxed whitespace-pre-wrap">${escapeHtml(description)}</div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="editItem(${article.id})" class="bg-green-500 text-white px-4 py-2 rounded text-sm hover:bg-green-600">Edit</button>
                        <button onclick="deleteItem(${article.id})" class="bg-red-500 text-white px-4 py-2 rounded text-sm hover:bg-red-600">Delete</button>
                    </div>
                </div>
            `;
        }

        function addContent() {
            if (currentView === 'jobs') {
                showJobModal();
            } else {
                showNewsModal();
            }
        }

        function showJobModal(job = null) {
            const isEdit = !!job;
            const title = isEdit ? 'Edit Job' : 'Add Job';
            
            const modal = createModal(title, `
                <div class="space-y-4">
                    <input type="text" id="modalTitle" placeholder="Job Title" value="${escapeHtml(job?.title || '')}" class="w-full p-3 border rounded">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="modalDept" placeholder="Department" value="${escapeHtml(job?.department || '')}" class="w-full p-3 border rounded">
                        <input type="text" id="modalLocation" placeholder="Location" value="${escapeHtml(job?.location || job?.lieu || '')}" class="w-full p-3 border rounded">
                        <input type="text" id="modalType" placeholder="Job Type" value="${escapeHtml(job?.type || '')}" class="w-full p-3 border rounded">
                        <input type="text" id="modalSalary" placeholder="Salary" value="${escapeHtml(job?.salary || job?.salaire || '')}" class="w-full p-3 border rounded">
                    </div>
                    <textarea id="modalDesc" placeholder="Full job description..." rows="6" class="w-full p-3 border rounded">${escapeHtml(job?.description || job?.summary || '')}</textarea>
                </div>
            `, () => saveJob(job?.id));
        }

        function showNewsModal(article = null) {
            const isEdit = !!article;
            const title = isEdit ? 'Edit News' : 'Add News';
            
            const modal = createModal(title, `
                <div class="space-y-4">
                    <input type="text" id="modalTitle" placeholder="News Title" value="${escapeHtml(article?.title || '')}" class="w-full p-3 border rounded">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="date" id="modalDate" value="${article?.date || new Date().toISOString().split('T')[0]}" class="w-full p-3 border rounded">
                        <input type="text" id="modalCategory" placeholder="Category" value="${escapeHtml(article?.category || article?.section || '')}" class="w-full p-3 border rounded">
                    </div>
                    <textarea id="modalDesc" placeholder="Full news content..." rows="6" class="w-full p-3 border rounded">${escapeHtml(article?.description || article?.summary || article?.content || '')}</textarea>
                </div>
            `, () => saveNews(article?.id));
        }

        function createModal(title, content, onSave) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = e => { if (e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg w-full max-w-2xl m-4 max-h-screen overflow-y-auto" onclick="event.stopPropagation()">
                    <h3 class="text-lg font-bold mb-4">${title}</h3>
                    ${content}
                    <div class="flex justify-end gap-2 mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-4 py-2 rounded">Cancel</button>
                        <button onclick="handleSave(this, ${onSave})" class="bg-blue-500 text-white px-4 py-2 rounded">Save</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }

        async function handleSave(button, saveFunction) {
            try {
                await saveFunction();
                button.closest('.fixed').remove();
                await loadContent();
            } catch (error) {
                alert('Save failed: ' + error.message);
            }
        }

        async function saveJob(jobId) {
            const data = {
                title: document.getElementById('modalTitle').value,
                department: document.getElementById('modalDept').value,
                location: document.getElementById('modalLocation').value,
                type: document.getElementById('modalType').value,
                salary: document.getElementById('modalSalary').value,
                description: document.getElementById('modalDesc').value,
                datePosted: new Date().toISOString().split('T')[0]
            };

            const url = jobId ? `/api/cms/jobs/${jobId}?lang=${currentLang}` : `/api/cms/jobs?lang=${currentLang}`;
            const method = jobId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error('Save failed');
        }

        async function saveNews(newsId) {
            const data = {
                title: document.getElementById('modalTitle').value,
                date: document.getElementById('modalDate').value,
                category: document.getElementById('modalCategory').value,
                description: document.getElementById('modalDesc').value
            };

            const url = newsId ? `/api/cms/news/${newsId}?lang=${currentLang}` : `/api/cms/news?lang=${currentLang}`;
            const method = newsId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error('Save failed');
        }

        function editItem(id) {
            const item = currentData.find(i => i.id == id);
            if (!item) return;
            
            if (currentView === 'jobs') {
                showJobModal(item);
            } else {
                showNewsModal(item);
            }
        }

        async function deleteItem(id) {
            if (!confirm(`Delete this ${currentView.slice(0, -1)}?`)) return;
            
            const endpoint = currentView === 'jobs' ? 'jobs' : 'news';
            const response = await fetch(`/api/cms/${endpoint}/${id}?lang=${currentLang}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                await loadContent();
            } else {
                alert('Delete failed');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateUI();
        });
    </script>
</body>
</html>