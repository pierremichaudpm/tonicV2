<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS Admin - Tonic Productions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full">
            <div class="text-center mb-6">
                <img src="../images/tonic-logo.png" alt="Tonic Logo" class="mx-auto h-16 mb-4">
                <h1 class="text-2xl font-bold text-gray-900">CMS Admin</h1>
                <p class="text-gray-600">Connexion Sécurisée</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nom d'utilisateur</label>
                    <input type="text" id="username" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Mot de passe</label>
                    <input type="password" id="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Se connecter
                </button>
                <div id="loginError" class="hidden text-red-600 text-sm text-center"></div>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <nav class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <img src="../images/tonic-logo.png" alt="Tonic Logo" class="h-8 mr-4">
                        <h1 class="text-xl font-semibold">CMS Tonic Productions</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="welcomeUser" class="text-gray-700"></span>
                        <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                            Déconnexion
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Language Selector -->
            <div class="mb-4">
                <div class="flex items-center space-x-4">
                    <label class="text-sm font-medium text-gray-700">Langue / Language:</label>
                    <select id="languageSelector" class="border border-gray-300 rounded px-3 py-1">
                        <option value="fr">Français</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>

            <!-- Tabs -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8">
                    <button id="jobsTab" class="tab-btn border-b-2 border-blue-500 py-2 px-1 text-blue-600 font-medium">
                        Gestion des Emplois
                    </button>
                    <button id="newsTab" class="tab-btn border-b-2 border-transparent py-2 px-1 text-gray-500 hover:text-gray-700">
                        Gestion des Actualités
                    </button>
                </nav>
            </div>

            <!-- Jobs Management -->
            <div id="jobsSection">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-lg font-semibold mb-4">Ajouter un Emploi</h2>
                    <form id="jobForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="jobId">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Titre</label>
                            <input type="text" id="jobTitle" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Département</label>
                            <input type="text" id="jobDepartment" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Lieu</label>
                            <input type="text" id="jobLocation" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Date limite</label>
                            <input type="date" id="jobDeadline" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea id="jobDescription" rows="4" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" id="jobSubmitBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                                Ajouter l'emploi
                            </button>
                            <button type="button" id="jobCancelBtn" class="hidden bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600 ml-2">
                                Annuler
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">Emplois Existants</h2>
                    <div id="jobsList" class="space-y-4"></div>
                </div>
            </div>

            <!-- News Management -->
            <div id="newsSection" class="hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-lg font-semibold mb-4">Ajouter une Actualité</h2>
                    <form id="newsForm" class="space-y-4">
                        <input type="hidden" id="newsId">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Titre</label>
                                <input type="text" id="newsTitle" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="newsDate" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Contenu</label>
                            <textarea id="newsContent" rows="6" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"></textarea>
                        </div>
                        <div>
                            <button type="submit" id="newsSubmitBtn" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                                Ajouter l'actualité
                            </button>
                            <button type="button" id="newsCancelBtn" class="hidden bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600 ml-2">
                                Annuler
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">Actualités Existantes</h2>
                    <div id="newsList" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('cms_token');
        let currentUser = localStorage.getItem('currentUser');

        // Check if already logged in
        if (authToken) {
            showDashboard();
        }

        // Login form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/cms/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    currentUser = data.username;
                    localStorage.setItem('cms_token', authToken);
                    localStorage.setItem('currentUser', currentUser);
                    showDashboard();
                } else {
                    showError('Nom d\'utilisateur ou mot de passe incorrect');
                }
            } catch (error) {
                showError('Erreur de connexion');
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('cms_token');
            localStorage.removeItem('currentUser');
            authToken = null;
            currentUser = null;
            showLogin();
        });

        // Show/hide screens
        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            document.getElementById('welcomeUser').textContent = `Bienvenue, ${currentUser}`;
            loadJobs();
            loadNews();
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Tab switching
        document.getElementById('jobsTab').addEventListener('click', () => switchTab('jobs'));
        document.getElementById('newsTab').addEventListener('click', () => switchTab('news'));

        function switchTab(tab) {
            // Update tab styling
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.getElementById(tab + 'Tab').classList.add('border-blue-500', 'text-blue-600');
            document.getElementById(tab + 'Tab').classList.remove('border-transparent', 'text-gray-500');

            // Show/hide sections
            document.getElementById('jobsSection').classList.toggle('hidden', tab !== 'jobs');
            document.getElementById('newsSection').classList.toggle('hidden', tab !== 'news');
        }

        // API helper
        async function apiRequest(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('cms_token')}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (response.status === 401) {
                localStorage.removeItem('cms_token');
                showLogin();
                throw new Error('Session expirée');
            }

            return response;
        }

        // Jobs management
        let jobs = [];
        let editingJobId = null;
        let currentLang = 'fr';

        // Language selector
        document.getElementById('languageSelector').addEventListener('change', (e) => {
            currentLang = e.target.value;
            console.log('Language changed to:', currentLang);
            loadJobs();
            loadNews();
        });

        async function loadJobs() {
            try {
                const response = await apiRequest(`/api/cms/jobs?lang=${currentLang}`);
                const data = await response.json();
                jobs = data.jobs;
                renderJobs();
            } catch (error) {
                console.error('Error loading jobs:', error);
            }
        }

        function renderJobs() {
            const jobsList = document.getElementById('jobsList');
            jobsList.innerHTML = jobs.map(job => `
                <div class="border rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-lg">${job.title}</h3>
                            <p class="text-gray-600">${job.department} • ${job.location}</p>
                            <p class="text-sm text-gray-500">Échéance: ${job.deadline}</p>
                            <p class="mt-2 text-sm">${job.description.substring(0, 100)}...</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editJob(${job.id})" class="text-blue-600 hover:underline">Modifier</button>
                            <button onclick="deleteJob(${job.id})" class="text-red-600 hover:underline">Supprimer</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('jobForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const jobData = {
                title: document.getElementById('jobTitle').value,
                department: document.getElementById('jobDepartment').value,
                location: document.getElementById('jobLocation').value,
                deadline: document.getElementById('jobDeadline').value,
                description: document.getElementById('jobDescription').value,
                lang: currentLang
            };

            try {
                if (editingJobId) {
                    await apiRequest(`/api/cms/jobs/${editingJobId}`, {
                        method: 'PUT',
                        body: JSON.stringify(jobData)
                    });
                } else {
                    await apiRequest('/api/cms/jobs', {
                        method: 'POST',
                        body: JSON.stringify(jobData)
                    });
                }

                document.getElementById('jobForm').reset();
                document.getElementById('jobId').value = '';
                editingJobId = null;
                updateJobFormUI(false);
                loadJobs();
            } catch (error) {
                alert('Erreur lors de la sauvegarde');
            }
        });

        function editJob(id) {
            const job = jobs.find(j => j.id === id);
            if (job) {
                document.getElementById('jobId').value = job.id;
                document.getElementById('jobTitle').value = job.title;
                document.getElementById('jobDepartment').value = job.department;
                document.getElementById('jobLocation').value = job.location;
                document.getElementById('jobDeadline').value = job.deadline;
                document.getElementById('jobDescription').value = job.description;
                editingJobId = id;
                updateJobFormUI(true);
            }
        }

        function updateJobFormUI(isEditing) {
            document.getElementById('jobSubmitBtn').textContent = isEditing ? 'Modifier l\'emploi' : 'Ajouter l\'emploi';
            document.getElementById('jobCancelBtn').classList.toggle('hidden', !isEditing);
        }

        document.getElementById('jobCancelBtn').addEventListener('click', () => {
            document.getElementById('jobForm').reset();
            editingJobId = null;
            updateJobFormUI(false);
        });

        async function deleteJob(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet emploi ?')) {
                try {
                    await apiRequest(`/api/cms/jobs/${id}?lang=${currentLang}`, { method: 'DELETE' });
                    loadJobs();
                } catch (error) {
                    alert('Erreur lors de la suppression');
                }
            }
        }

        // News management (similar structure to jobs)
        let news = [];
        let editingNewsId = null;

        async function loadNews() {
            try {
                const response = await apiRequest(`/api/cms/news?lang=${currentLang}`);
                const data = await response.json();
                news = data.news;
                renderNews();
            } catch (error) {
                console.error('Error loading news:', error);
            }
        }

        function renderNews() {
            const newsList = document.getElementById('newsList');
            newsList.innerHTML = news.map(article => `
                <div class="border rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-lg">${article.title}</h3>
                            <p class="text-gray-600">${article.date}</p>
                            <p class="mt-2 text-sm">${article.content.substring(0, 150)}...</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editNews(${article.id})" class="text-blue-600 hover:underline">Modifier</button>
                            <button onclick="deleteNews(${article.id})" class="text-red-600 hover:underline">Supprimer</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('newsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newsData = {
                title: document.getElementById('newsTitle').value,
                date: document.getElementById('newsDate').value,
                content: document.getElementById('newsContent').value,
                lang: currentLang
            };

            try {
                if (editingNewsId) {
                    await apiRequest(`/api/cms/news/${editingNewsId}`, {
                        method: 'PUT',
                        body: JSON.stringify(newsData)
                    });
                } else {
                    await apiRequest('/api/cms/news', {
                        method: 'POST',
                        body: JSON.stringify(newsData)
                    });
                }

                document.getElementById('newsForm').reset();
                document.getElementById('newsId').value = '';
                editingNewsId = null;
                updateNewsFormUI(false);
                loadNews();
            } catch (error) {
                alert('Erreur lors de la sauvegarde');
            }
        });

        function editNews(id) {
            const article = news.find(n => n.id === id);
            if (article) {
                document.getElementById('newsId').value = article.id;
                document.getElementById('newsTitle').value = article.title;
                document.getElementById('newsDate').value = article.date;
                document.getElementById('newsContent').value = article.content;
                editingNewsId = id;
                updateNewsFormUI(true);
            }
        }

        function updateNewsFormUI(isEditing) {
            document.getElementById('newsSubmitBtn').textContent = isEditing ? 'Modifier l\'actualité' : 'Ajouter l\'actualité';
            document.getElementById('newsCancelBtn').classList.toggle('hidden', !isEditing);
        }

        document.getElementById('newsCancelBtn').addEventListener('click', () => {
            document.getElementById('newsForm').reset();
            editingNewsId = null;
            updateNewsFormUI(false);
        });

        async function deleteNews(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette actualité ?')) {
                try {
                    await apiRequest(`/api/cms/news/${id}?lang=${currentLang}`, { method: 'DELETE' });
                    loadNews();
                } catch (error) {
                    alert('Erreur lors de la suppression');
                }
            }
        }
    </script>
</body>
</html>