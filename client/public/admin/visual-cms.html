<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS Visual - Groupe Tonic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@editorjs/editorjs@latest"></script>
    <script src="https://unpkg.com/@editorjs/header@latest"></script>
    <script src="https://unpkg.com/@editorjs/list@latest"></script>
    <script src="https://unpkg.com/@editorjs/paragraph@latest"></script>
    <style>
        .ce-toolbar__content { max-width: calc(100% - 70px) !important; }
        .ce-block__content { max-width: 100% !important; }
        .codex-editor__redactor { padding-bottom: 100px !important; }
        .ce-toolbar__plus { color: #4b5563 !important; }
        .ce-toolbar__settings-btn { color: #4b5563 !important; }
        .ce-block { margin: 0 !important; }
        .ce-paragraph { line-height: 1.6 !important; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="flex items-center justify-between px-6 py-4">
            <h1 class="text-2xl font-bold text-gray-800">Système de gestion de contenu</h1>
            <button onclick="logout()" class="text-gray-600 hover:text-gray-800">Se déconnecter</button>
        </div>
        
        <!-- Navigation -->
        <nav class="flex px-6 py-3 space-x-4 bg-gray-50">
            <button onclick="setContentType('jobs')" id="jobsBtn" class="px-4 py-2 rounded font-medium bg-blue-500 text-white">
                Emplois / Jobs
            </button>
            <button onclick="setContentType('news')" id="newsBtn" class="px-4 py-2 rounded font-medium text-gray-600 hover:text-gray-800">
                Communiqués / News
            </button>
            <div class="ml-auto">
                <select id="langSelect" onchange="changeLanguage()" class="px-4 py-2 border rounded">
                    <option value="fr">Français</option>
                    <option value="en">English</option>
                </select>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="mb-6 flex justify-between items-center">
            <h2 class="text-xl font-semibold text-gray-700">Contenu</h2>
            <button onclick="addNew()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                + Ajouter nouveau
            </button>
        </div>
        <div id="content" class="space-y-4">
            <!-- Content will be loaded here -->
        </div>
    </main>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b">
                <h2 id="modalTitle" class="text-2xl font-bold">Éditer</h2>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <form id="editForm">
                    <input type="hidden" id="itemId">
                    
                    <!-- Job Fields -->
                    <div id="jobFields" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="title" placeholder="Titre du poste" class="p-2 border rounded">
                            <select id="department" class="p-2 border rounded">
                                <option value="">Sélectionner un département</option>
                                <option value="Administration">Administration</option>
                                <option value="Événements">Événements</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Opérations">Opérations</option>
                                <option value="Cuisine">Cuisine</option>
                                <option value="Service">Service</option>
                                <option value="Technique">Technique</option>
                                <option value="Direction">Direction</option>
                            </select>
                            <input type="text" id="location" placeholder="Lieu" class="p-2 border rounded">
                            <input type="text" id="type" placeholder="Type" class="p-2 border rounded">
                            <input type="text" id="salary" placeholder="Salaire" class="p-2 border rounded">
                            <input type="text" id="deadline" placeholder="Date limite" class="p-2 border rounded">
                        </div>
                        <div class="border rounded p-4 bg-gray-50">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description du poste</label>
                            <div id="jobEditor" class="bg-white border rounded min-h-[300px]"></div>
                        </div>
                    </div>

                    <!-- News Fields -->
                    <div id="newsFields" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="newsTitle" placeholder="Titre" class="p-2 border rounded">
                            <input type="date" id="date" class="p-2 border rounded">
                            <select id="category" class="p-2 border rounded">
                                <option value="">Sélectionner une catégorie</option>
                                <option value="Événements">Événements</option>
                                <option value="Nouvelles corporatives">Nouvelles corporatives</option>
                                <option value="Partenariats">Partenariats</option>
                                <option value="Médias">Médias</option>
                                <option value="Annonces">Annonces</option>
                                <option value="Prix et distinctions">Prix et distinctions</option>
                                <option value="Communauté">Communauté</option>
                            </select>
                            <select id="newsDepartment" class="p-2 border rounded">
                                <option value="">Sélectionner un département</option>
                                <option value="Administration">Administration</option>
                                <option value="Événements">Événements</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Opérations">Opérations</option>
                                <option value="Production">Production</option>
                                <option value="Groupe Tonic">Groupe Tonic</option>
                            </select>
                            <input type="text" id="summary" placeholder="Résumé" class="p-2 border rounded" style="grid-column: span 2;">
                        </div>
                        <div class="border rounded p-4 bg-gray-50">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contenu de l'article</label>
                            <div id="newsEditor" class="bg-white border rounded min-h-[300px]"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="p-6 border-t bg-gray-50">
                <div class="flex gap-2 justify-end">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-100">
                        Annuler
                    </button>
                    <button type="button" onclick="save()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Sauvegarder
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let editor = null;
        let currentType = 'jobs';
        let currentLang = 'fr';
        let token = localStorage.getItem('cmsToken');

        // Check authentication
        if (!token) {
            window.location.href = '/admin/';
        }

        // Initialize editor
        function initEditor(editorId) {
            return new EditorJS({
                holder: editorId,
                tools: {
                    header: {
                        class: Header,
                        config: {
                            levels: [2, 3, 4],
                            defaultLevel: 3
                        }
                    },
                    list: {
                        class: List,
                        inlineToolbar: true
                    },
                    paragraph: {
                        class: Paragraph,
                        inlineToolbar: true
                    }
                },
                placeholder: 'Cliquez ici pour commencer à écrire...'
            });
        }

        // Load content
        async function loadContent() {
            try {
                const endpoint = currentType === 'jobs' ? `/api/cms/jobs?lang=${currentLang}` : `/api/cms/news?lang=${currentLang}`;
                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load content');
                
                const data = await response.json();
                const items = currentType === 'jobs' ? data.jobs : data.news;
                
                // Filter items by language
                const filteredItems = items.filter(item => {
                    // For existing items without lang property, show in French by default
                    return (item.lang || 'fr') === currentLang;
                });
                
                renderContent(filteredItems);
            } catch (error) {
                console.error('Error loading content:', error);
            }
        }

        // Render content list
        function renderContent(items) {
            const contentDiv = document.getElementById('content');
            
            if (!items || items.length === 0) {
                contentDiv.innerHTML = '<p class="text-gray-500">Aucun contenu disponible.</p>';
                return;
            }
            
            contentDiv.innerHTML = items.map(item => `
                <div class="bg-white p-6 rounded-lg shadow-sm border">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-semibold">${item.title || item.newsTitle}</h3>
                            <p class="text-gray-600 text-sm mt-1">
                                ${currentType === 'jobs' ? 
                                    `${item.department || ''} • ${item.location || ''}` : 
                                    `${item.category || ''} • ${formatDate(item.date)}`}
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="edit(${item.id})" class="text-blue-600 hover:text-blue-800">
                                Éditer
                            </button>
                            <button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-800">
                                Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Add new item
        function addNew() {
            document.getElementById('itemId').value = '';
            document.getElementById('modalTitle').textContent = currentType === 'jobs' ? 'Ajouter un emploi' : 'Ajouter un communiqué';
            
            // Reset form
            document.getElementById('editForm').reset();
            
            // Show appropriate fields
            document.getElementById('jobFields').classList.toggle('hidden', currentType !== 'jobs');
            document.getElementById('newsFields').classList.toggle('hidden', currentType !== 'news');
            
            // Initialize editor
            if (editor) editor.destroy();
            editor = initEditor(currentType === 'jobs' ? 'jobEditor' : 'newsEditor');
            
            // Show modal
            document.getElementById('modal').classList.remove('hidden');
        }

        // Edit item
        async function edit(id) {
            try {
                const endpoint = currentType === 'jobs' ? `/api/cms/jobs` : `/api/cms/news`;
                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load item');
                
                const data = await response.json();
                const items = currentType === 'jobs' ? data.jobs : data.news;
                const item = items.find(i => i.id === id);
                
                if (!item) return;
                
                // Fill form
                document.getElementById('itemId').value = item.id;
                
                if (currentType === 'jobs') {
                    document.getElementById('title').value = item.title || '';
                    document.getElementById('department').value = item.department || '';
                    document.getElementById('location').value = item.location || '';
                    document.getElementById('type').value = item.type || '';
                    document.getElementById('salary').value = item.salary || '';
                    document.getElementById('deadline').value = item.deadline || '';
                } else {
                    document.getElementById('newsTitle').value = item.title || '';
                    document.getElementById('date').value = item.date || '';
                    document.getElementById('category').value = item.category || '';
                    document.getElementById('newsDepartment').value = item.department || '';
                    document.getElementById('summary').value = item.summary || '';
                }
                
                // Show appropriate fields
                document.getElementById('jobFields').classList.toggle('hidden', currentType !== 'jobs');
                document.getElementById('newsFields').classList.toggle('hidden', currentType !== 'news');
                
                // Initialize editor with content
                if (editor) editor.destroy();
                editor = initEditor(currentType === 'jobs' ? 'jobEditor' : 'newsEditor');
                
                // Convert HTML to editor blocks
                setTimeout(() => {
                    if (item.description || item.content) {
                        const htmlContent = item.description || item.content;
                        const blocks = htmlToEditorBlocks(htmlContent);
                        editor.render({ blocks });
                    }
                }, 100);
                
                // Show modal
                document.getElementById('modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading item:', error);
            }
        }

        // Convert HTML to Editor.js blocks
        function htmlToEditorBlocks(html) {
            const blocks = [];
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            tempDiv.childNodes.forEach(node => {
                if (node.nodeType === 1) { // Element node
                    if (node.tagName === 'H1' || node.tagName === 'H2' || node.tagName === 'H3') {
                        blocks.push({
                            type: 'header',
                            data: {
                                text: node.textContent,
                                level: parseInt(node.tagName.charAt(1))
                            }
                        });
                    } else if (node.tagName === 'UL' || node.tagName === 'OL') {
                        const items = Array.from(node.querySelectorAll('li')).map(li => li.innerHTML);
                        blocks.push({
                            type: 'list',
                            data: {
                                style: node.tagName === 'OL' ? 'ordered' : 'unordered',
                                items
                            }
                        });
                    } else if (node.tagName === 'P' || node.tagName === 'DIV') {
                        if (node.textContent.trim()) {
                            blocks.push({
                                type: 'paragraph',
                                data: {
                                    text: node.innerHTML
                                }
                            });
                        }
                    }
                } else if (node.nodeType === 3 && node.textContent.trim()) { // Text node
                    blocks.push({
                        type: 'paragraph',
                        data: {
                            text: node.textContent
                        }
                    });
                }
            });
            
            return blocks;
        }

        // Convert Editor.js blocks to HTML
        async function editorToHtml(editorInstance) {
            const data = await editorInstance.save();
            let html = '';
            
            data.blocks.forEach(block => {
                switch (block.type) {
                    case 'header':
                        html += `<h${block.data.level}>${block.data.text}</h${block.data.level}>`;
                        break;
                    case 'paragraph':
                        html += `<p>${block.data.text}</p>`;
                        break;
                    case 'list':
                        const tag = block.data.style === 'ordered' ? 'ol' : 'ul';
                        html += `<${tag}>${block.data.items.map(item => `<li>${item}</li>`).join('')}</${tag}>`;
                        break;
                }
            });
            
            return html;
        }

        // Save item
        async function save() {
            try {
                const id = document.getElementById('itemId').value;
                const method = id ? 'PUT' : 'POST';
                const endpoint = currentType === 'jobs' 
                    ? (id ? `/api/cms/jobs/${id}` : '/api/cms/jobs')
                    : (id ? `/api/cms/news/${id}` : '/api/cms/news');
                
                // Get editor content as HTML
                const htmlContent = await editorToHtml(editor);
                
                let body;
                if (currentType === 'jobs') {
                    body = {
                        title: document.getElementById('title').value,
                        department: document.getElementById('department').value,
                        location: document.getElementById('location').value,
                        type: document.getElementById('type').value,
                        salary: document.getElementById('salary').value,
                        deadline: document.getElementById('deadline').value,
                        description: htmlContent,
                        datePosted: new Date().toISOString().split('T')[0],
                        lang: currentLang
                    };
                } else {
                    body = {
                        title: document.getElementById('newsTitle').value,
                        date: document.getElementById('date').value,
                        category: document.getElementById('category').value,
                        department: document.getElementById('newsDepartment').value,
                        summary: document.getElementById('summary').value,
                        content: htmlContent,
                        lang: currentLang
                    };
                }
                
                const response = await fetch(endpoint, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) throw new Error('Failed to save');
                
                closeModal();
                loadContent();
            } catch (error) {
                console.error('Error saving:', error);
                alert('Erreur lors de la sauvegarde');
            }
        }

        // Delete item
        async function deleteItem(id) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cet élément?')) return;
            
            try {
                const endpoint = currentType === 'jobs' ? `/api/cms/jobs/${id}` : `/api/cms/news/${id}`;
                const response = await fetch(endpoint, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to delete');
                
                loadContent();
            } catch (error) {
                console.error('Error deleting:', error);
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            if (editor) {
                editor.destroy();
                editor = null;
            }
        }

        // Change content type
        function setContentType(type) {
            currentType = type;
            
            // Update button styles
            document.getElementById('jobsBtn').classList.toggle('bg-blue-500', type === 'jobs');
            document.getElementById('jobsBtn').classList.toggle('text-white', type === 'jobs');
            document.getElementById('jobsBtn').classList.toggle('text-gray-600', type !== 'jobs');
            
            document.getElementById('newsBtn').classList.toggle('bg-blue-500', type === 'news');
            document.getElementById('newsBtn').classList.toggle('text-white', type === 'news');
            document.getElementById('newsBtn').classList.toggle('text-gray-600', type !== 'news');
            
            loadContent();
        }

        // Change language
        function changeLanguage() {
            currentLang = document.getElementById('langSelect').value;
            loadContent();
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }

        // Logout
        function logout() {
            localStorage.removeItem('cmsToken');
            window.location.href = '/admin/';
        }

        // Initialize
        loadContent();
    </script>
</body>
</html>