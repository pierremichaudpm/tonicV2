<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS Éditable - Groupe Tonic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Hide browser notification popups and overlays */
        .notification-overlay,
        [role="dialog"][aria-label*="notification"],
        [data-testid*="notification"] {
            display: none !important;
        }
        
        /* Ensure modal appears above any browser popups */
        #editModal {
            z-index: 999999 !important;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="/images/tonic-logo.png" alt="Groupe Tonic" class="h-10">
                    <div>
                        <p class="text-sm text-gray-600">Système de Gestion de Contenu</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <select id="contentType" class="border rounded px-3 py-2">
                        <option value="jobs">Emplois / Jobs</option>
                        <option value="news">Communiqués / News</option>
                    </select>
                    <select id="language" class="border rounded px-3 py-2">
                        <option value="fr">Français</option>
                        <option value="en">English</option>
                    </select>
                    <button onclick="showAddForm()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        + Ajouter
                    </button>
                    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        Déconnexion
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8">
            
            <div id="content" class="space-y-4">
                <!-- Content will be loaded here -->
            </div>
        </main>

        <!-- Edit Modal -->
        <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="closeModalOnBackdrop(event)">
            <div class="bg-white rounded-lg w-full max-w-5xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <div class="p-6">
                    <h2 id="modalTitle" class="text-2xl font-bold mb-4">Éditer</h2>
                    <form id="editForm" class="space-y-4">
                        <input type="hidden" id="itemId">
                        
                        <!-- Job Fields -->
                        <div class="jobFields">
                            <div class="bg-gray-50 p-4 rounded-lg space-y-4">
                                <h3 class="font-semibold text-lg">Informations principales</h3>
                                <input type="text" id="title" placeholder="Titre du poste" class="w-full p-3 border rounded">
                                <div class="grid grid-cols-2 gap-4">
                                    <select id="department" class="p-3 border rounded">
                                        <option value="">Sélectionner un département</option>
                                        <option value="Administration">Administration</option>
                                        <option value="Événements">Événements</option>
                                        <option value="Marketing">Marketing</option>
                                        <option value="Production">Production</option>
                                        <option value="Cuisine">Cuisine</option>
                                        <option value="Kitchen">Kitchen</option>
                                        <option value="Direction">Direction</option>
                                        <option value="Groupe Tonic">Groupe Tonic</option>
                                    </select>
                                    <input type="text" id="location" placeholder="Lieu de travail" class="p-3 border rounded">
                                    <input type="text" id="type" placeholder="Type (Temps plein, etc.)" class="p-3 border rounded">
                                    <input type="text" id="salary" placeholder="Salaire" class="p-3 border rounded">
                                    <input type="date" id="datePosted" placeholder="Date de publication" class="p-3 border rounded">
                                    <input type="text" id="deadline" placeholder="Date limite (ex: 28 juillet 2025)" class="p-3 border rounded">
                                </div>
                                <textarea id="summary" placeholder="Résumé court (optionnel)" rows="2" class="w-full p-3 border rounded"></textarea>
                            </div>
                            
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-lg mb-2">Description complète</h3>
                                <p class="text-sm text-gray-600 mb-3">Écrivez la description en texte simple. Le formatage sera fait automatiquement.</p>
                                <textarea id="description" placeholder="Description complète du poste..." rows="15" class="w-full p-3 border rounded bg-white"></textarea>
                            </div>
                        </div>

                        <!-- News Fields -->
                        <div class="newsFields hidden">
                            <div class="bg-gray-50 p-4 rounded-lg space-y-4">
                                <h3 class="font-semibold text-lg">Informations principales</h3>
                                <input type="text" id="newsTitle" placeholder="Titre du communiqué" class="w-full p-3 border rounded">
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="date" id="date" placeholder="Date" class="p-3 border rounded">
                                    <select id="category" class="p-3 border rounded">
                                        <option value="">Sélectionner une catégorie</option>
                                        <option value="Événements">Événements</option>
                                        <option value="Nouvelles corporatives">Nouvelles corporatives</option>
                                        <option value="Partenariats">Partenariats</option>
                                        <option value="Médias">Médias</option>
                                        <option value="Annonces">Annonces</option>
                                        <option value="Prix et distinctions">Prix et distinctions</option>
                                        <option value="Communauté">Communauté</option>
                                    </select>
                                </div>
                                <select id="newsDepartment" class="w-full p-3 border rounded">
                                    <option value="">Sélectionner un département</option>
                                    <option value="Administration">Administration</option>
                                    <option value="Événements">Événements</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Production">Production</option>
                                    <option value="Groupe Tonic">Groupe Tonic</option>
                                </select>
                                <textarea id="newsSummary" placeholder="Résumé court" rows="2" class="w-full p-3 border rounded"></textarea>
                            </div>
                            
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-lg mb-2">Contenu complet</h3>
                                <p class="text-sm text-gray-600 mb-3">Écrivez le contenu en texte simple. Le formatage sera fait automatiquement.</p>
                                <textarea id="content" placeholder="Contenu complet du communiqué..." rows="15" class="w-full p-3 border rounded bg-white"></textarea>
                            </div>
                        </div>

                        <div class="flex gap-2 justify-end">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-100">
                                Annuler
                            </button>
                            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                Sauvegarder
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Dialog -->
    <div id="confirmDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 class="text-lg font-semibold mb-4">Confirmation</h3>
            <p id="confirmMessage" class="text-gray-700 mb-6"></p>
            <div class="flex gap-3 justify-end">
                <button id="confirmCancel" class="px-4 py-2 border rounded hover:bg-gray-100">
                    Annuler
                </button>
                <button id="confirmOK" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    Supprimer
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentType = 'jobs';
        let currentLang = 'fr';
        let currentData = [];

        // Simple password check
        const PASSWORD = 'admin123';
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadContent();
        });
        
        // Strip HTML tags from text
        function stripHtml(html) {
            const tmp = document.createElement('DIV');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        document.getElementById('contentType').addEventListener('change', (e) => {
            currentType = e.target.value;
            toggleFieldVisibility();
            loadContent();
        });

        document.getElementById('language').addEventListener('change', (e) => {
            currentLang = e.target.value;
            loadContent();
        });

        document.getElementById('editForm').addEventListener('submit', saveItem);

        function toggleFieldVisibility() {
            const jobFields = document.querySelector('.jobFields');
            const newsFields = document.querySelector('.newsFields');
            
            if (currentType === 'jobs') {
                jobFields.classList.remove('hidden');
                newsFields.classList.add('hidden');
            } else {
                jobFields.classList.add('hidden');
                newsFields.classList.remove('hidden');
            }
        }

        function logout() {
            window.location.href = '/admin/';
        }
        


        // Simple fetch with password authentication
        async function fetchWithAuth(url, options = {}) {
            try {
                console.log('Making request to:', url);
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'X-Admin-Password': PASSWORD,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });

                console.log('Response received:', response.status, response.statusText);
                
                if (response.status === 401 || response.status === 403) {
                    console.log('Authentication failed, redirecting to login');
                    window.location.href = '/admin/';
                    return null;
                }

                return response;
            } catch (error) {
                console.error('Fetch error:', error);
                return null;
            }
        }

        async function loadContent() {
            try {
                console.log('Loading content:', currentType, currentLang);
                const response = await fetchWithAuth(`/api/cms/${currentType}?lang=${currentLang}`);
                
                if (!response) {
                    console.log('No response received');
                    return;
                }

                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Data received:', data);
                currentData = currentType === 'jobs' ? data.jobs : data.news;
                console.log('Current data set to:', currentData);
                displayContent(currentData);
            } catch (error) {
                console.error('Error loading content:', error);
                console.error('Full error:', JSON.stringify(error, null, 2));
            }
        }

        function displayContent(items) {
            const container = document.getElementById('content');
            
            if (!items || items.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun contenu</p>';
                return;
            }

            container.innerHTML = items.map(item => {
                if (currentType === 'jobs') {
                    // Extract plain text from description
                    let descText = '';
                    if (item.description) {
                        const temp = document.createElement('div');
                        temp.innerHTML = item.description;
                        descText = temp.textContent || temp.innerText || '';
                        descText = descText.substring(0, 200) + (descText.length > 200 ? '...' : '');
                    }
                    
                    return `
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="text-xl font-bold text-blue-600">${item.title || ''}</h3>
                                    <div class="text-sm text-gray-600 mt-2">
                                        <strong>Department:</strong> ${item.department || 'N/A'} | 
                                        <strong>Location:</strong> ${item.location || item.lieu || 'N/A'} | 
                                        <strong>Type:</strong> ${item.type || 'N/A'}
                                    </div>
                                    ${descText ? `<div class="mt-3 text-gray-700 border-l-4 border-blue-200 pl-4">
                                        <strong>Description:</strong><br>${descText}
                                    </div>` : '<div class="mt-3 text-gray-500 italic">No description available</div>'}
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editItem(${item.id})" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                        Éditer
                                    </button>
                                    <button onclick="deleteItem(${item.id})" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                        Supprimer
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Extract plain text from content
                    let contentText = '';
                    if (item.content) {
                        const temp = document.createElement('div');
                        temp.innerHTML = item.content;
                        contentText = temp.textContent || temp.innerText || '';
                        contentText = contentText.substring(0, 200) + (contentText.length > 200 ? '...' : '');
                    }
                    
                    return `
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="text-xl font-bold text-purple-600">${item.title || ''}</h3>
                                    <div class="text-sm text-gray-600 mt-2">
                                        <strong>Date:</strong> ${item.date || 'N/A'} | 
                                        <strong>Category:</strong> ${item.category || 'N/A'} | 
                                        <strong>Department:</strong> ${item.department || 'N/A'}
                                    </div>
                                    ${contentText ? `<div class="mt-3 text-gray-700 border-l-4 border-purple-200 pl-4">
                                        <strong>Content:</strong><br>${contentText}
                                    </div>` : '<div class="mt-3 text-gray-500 italic">No content available</div>'}
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editItem(${item.id})" class="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600">
                                        Éditer
                                    </button>
                                    <button onclick="deleteItem(${item.id})" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                        Supprimer
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        function showAddForm() {
            document.getElementById('modalTitle').textContent = 'Ajouter';
            document.getElementById('editForm').reset();
            document.getElementById('itemId').value = '';
            toggleFieldVisibility();
            document.getElementById('editModal').classList.remove('hidden');
        }

        function editItem(id) {
            const item = currentData.find(i => i.id == id);
            if (!item) return;

            document.getElementById('modalTitle').textContent = 'Éditer';
            document.getElementById('itemId').value = id;

            if (currentType === 'jobs') {
                document.getElementById('title').value = item.title || '';
                document.getElementById('department').value = item.department || '';
                document.getElementById('location').value = item.location || item.lieu || '';
                document.getElementById('type').value = item.type || '';
                document.getElementById('salary').value = item.salary || item.salaire || '';
                document.getElementById('datePosted').value = item.datePosted || '';
                document.getElementById('deadline').value = item.deadline || '';
                document.getElementById('summary').value = item.summary || '';
                // Convert HTML to plain text for editing
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = item.description || '';
                document.getElementById('description').value = tempDiv.textContent || tempDiv.innerText || '';
            } else {
                document.getElementById('newsTitle').value = item.title || '';
                document.getElementById('date').value = item.date || '';
                document.getElementById('category').value = item.category || '';
                document.getElementById('newsDepartment').value = item.department || '';
                document.getElementById('newsSummary').value = item.summary || '';
                // Convert HTML to plain text for editing
                const tempDiv2 = document.createElement('div');
                tempDiv2.innerHTML = item.content || '';
                document.getElementById('content').value = tempDiv2.textContent || tempDiv2.innerText || '';
            }

            toggleFieldVisibility();
            document.getElementById('editModal').classList.remove('hidden');
        }

        async function saveItem(e) {
            e.preventDefault();
            
            try {
                const id = document.getElementById('itemId').value;
                const isNew = !id;
                
                let data = { lang: currentLang };
                
                if (currentType === 'jobs') {
                    // Convert plain text back to HTML with paragraphs
                    const descText = document.getElementById('description').value;
                    const descHtml = descText.split('\n\n').map(para => 
                        para.trim() ? `<p>${para.trim()}</p>` : ''
                    ).join('\n');
                    
                    data = {
                        ...data,
                        title: document.getElementById('title').value,
                        department: document.getElementById('department').value,
                        location: document.getElementById('location').value,
                        type: document.getElementById('type').value,
                        salary: document.getElementById('salary').value,
                        datePosted: document.getElementById('datePosted').value,
                        deadline: document.getElementById('deadline').value,
                        summary: document.getElementById('summary').value,
                        description: descHtml
                    };
                } else {
                    // Convert plain text back to HTML with paragraphs
                    const contentText = document.getElementById('content').value;
                    const contentHtml = contentText.split('\n\n').map(para => 
                        para.trim() ? `<p>${para.trim()}</p>` : ''
                    ).join('\n');
                    
                    data = {
                        ...data,
                        title: document.getElementById('newsTitle').value,
                        date: document.getElementById('date').value,
                        category: document.getElementById('category').value,
                        department: document.getElementById('newsDepartment').value,
                        summary: document.getElementById('newsSummary').value,
                        content: contentHtml
                    };
                }

                console.log('Saving data:', data);
                
                const url = isNew 
                    ? `/api/cms/${currentType}` 
                    : `/api/cms/${currentType}/${id}`;
                
                const response = await fetchWithAuth(url, {
                    method: isNew ? 'POST' : 'PUT',
                    body: JSON.stringify(data)
                });

                if (!response) return; // Already handled redirect

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`Save failed: ${response.status} ${errorText}`);
                }
                
                closeModal();
                await loadContent();
                alert(isNew ? 'Créé avec succès' : 'Modifié avec succès');
            } catch (error) {
                console.error('Save error:', error);
                alert(`Erreur de sauvegarde: ${error.message}`);
            }
        }

        async function deleteItem(id) {
            if (!await showConfirmDialog('Êtes-vous sûr de vouloir supprimer cet élément?')) return;

            try {
                const response = await fetchWithAuth(`/api/cms/${currentType}/${id}?lang=${currentLang}`, {
                    method: 'DELETE'
                });

                if (!response) return; // Already handled redirect
                if (!response.ok) throw new Error('Delete failed');
                
                loadContent();
                alert('Supprimé avec succès');
            } catch (error) {
                console.error('Error:', error);
                alert('Erreur de suppression');
            }
        }

        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
        }
        
        function closeModalOnBackdrop(event) {
            if (event.target === event.currentTarget) {
                closeModal();
            }
        }

        // Custom confirmation dialog
        function showConfirmDialog(message) {
            return new Promise((resolve) => {
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmDialog').classList.remove('hidden');
                
                document.getElementById('confirmOK').onclick = () => {
                    document.getElementById('confirmDialog').classList.add('hidden');
                    resolve(true);
                };
                
                document.getElementById('confirmCancel').onclick = () => {
                    document.getElementById('confirmDialog').classList.add('hidden');
                    resolve(false);
                };
            });
        }

        // Helper functions for HTML editing
        function insertTag(tag) {
            const textarea = document.getElementById('description');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const replacement = `<${tag}>${selectedText}</${tag}>`;
            
            textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + tag.length + 2, start + tag.length + 2 + selectedText.length);
        }

        function insertList() {
            const textarea = document.getElementById('description');
            const start = textarea.selectionStart;
            const listTemplate = '<ul>\n  <li></li>\n  <li></li>\n  <li></li>\n</ul>';
            
            textarea.value = textarea.value.substring(0, start) + listTemplate + textarea.value.substring(start);
            textarea.focus();
            textarea.setSelectionRange(start + 9, start + 9);
        }

        // Load initial content
        toggleFieldVisibility();
        
        // Check initial content type and show department filter if needed
        if (document.getElementById('contentType').value === 'news') {
            document.getElementById('departmentFilter').style.display = 'block';
        }
    </script>
</body>
</html>