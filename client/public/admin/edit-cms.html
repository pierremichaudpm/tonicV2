<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS √âditable - Groupe Tonic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tonic-bg {
            background: linear-gradient(135deg, #fe4445 0%, #ff6667 50%, #fe4445 100%);
            background-size: 300% 300%;
            animation: gradientShift 8s ease-in-out infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Hide browser notification popups and overlays */
        .notification-overlay,
        [role="dialog"][aria-label*="notification"],
        [data-testid*="notification"] {
            display: none !important;
        }
        
        /* Ensure modal appears above any browser popups */
        #editModal {
            z-index: 999999 !important;
        }
        
        /* Debug console styles */
        #debugConsole {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 400px;
            max-height: 300px;
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            z-index: 9999;
            display: none;
        }
        
        #debugToggle {
            position: fixed;
            bottom: 10px;
            right: 420px;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 9999;
        }
        
        /* CMS content preview styles */
        .cms-content-preview p {
            margin-bottom: 0.5rem;
        }
        
        .cms-content-preview p:last-child {
            margin-bottom: 0;
        }
        
        .cms-content-preview strong {
            font-weight: 700;
            color: #1a202c;
        }
        
        .cms-content-preview a {
            color: #1d4ed8;
            text-decoration: underline;
            hover: #2563eb;
        }
        
        .cms-content-preview a:hover {
            color: #2563eb;
        }
    </style>
</head>
<body class="tonic-bg">
    <!-- Debug Console -->
    <div id="debugToggle" onclick="toggleDebugConsole()">Debug üêõ</div>
    <div id="debugConsole">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <strong>Debug Console</strong>
            <button onclick="clearDebugConsole()" style="background: #444; padding: 2px 8px; border-radius: 3px;">Clear</button>
        </div>
        <div id="debugLog"></div>
    </div>

    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <!-- Mobile Layout: Stack everything -->
                <div class="flex flex-col gap-4 md:hidden">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <img src="/images/tonic-logo.png" alt="Groupe Tonic" class="h-8">
                        </div>
                        <button onclick="logout()" class="bg-red-500 text-white px-3 py-1.5 text-sm rounded hover:bg-red-600">
                            D√©connexion
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <select id="contentType" class="flex-1 border rounded px-2 py-1.5 text-sm">
                            <option value="jobs">Emplois / Jobs</option>
                            <option value="news">Communiqu√©s / News</option>
                        </select>
                        <select id="language" class="border rounded px-2 py-1.5 text-sm">
                            <option value="fr">FR</option>
                            <option value="en">EN</option>
                        </select>
                        <button onclick="showAddForm()" class="bg-green-500 text-white px-3 py-1.5 text-sm rounded hover:bg-green-600">
                            + Add
                        </button>
                    </div>
                </div>
                
                <!-- Desktop Layout: Original horizontal layout -->
                <div class="hidden md:flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <img src="/images/tonic-logo.png" alt="Groupe Tonic" class="h-10">
                        <div>
                            <p class="text-sm text-gray-600">Syst√®me de Gestion de Contenu</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <select id="contentTypeDesktop" class="border rounded px-3 py-2">
                            <option value="jobs">Emplois / Jobs</option>
                            <option value="news">Communiqu√©s / News</option>
                        </select>
                        <select id="languageDesktop" class="border rounded px-3 py-2">
                            <option value="fr">Fran√ßais</option>
                            <option value="en">English</option>
                        </select>
                        <button onclick="showAddForm()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            + Ajouter
                        </button>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            D√©connexion
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8">
            <!-- Auto-Fix Alert for Plain Text Content -->
            <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-4">
                <strong>üîß Correction automatique du formatage</strong>
                <ul class="text-sm mt-2 space-y-1">
                    <li><strong>Probl√®me:</strong> Le contenu existant est en texte brut (pas de gras, pas de liens)</li>
                    <li><strong>Solution rapide:</strong> Ouvrez la console (F12) et tapez <code class="bg-blue-200 px-1">autoFixPlainTextContent()</code></li>
                    <li><strong>Diagnostic:</strong> Utilisez <code class="bg-blue-200 px-1">checkContent()</code> pour voir l'√©tat du formatage</li>
                    <li><strong>Manuel:</strong> √âditez chaque item et recollez depuis Word pour ajouter du formatage avanc√©</li>
                </ul>
            </div>
            
            <div id="content" class="space-y-4">
                <!-- Content will be loaded here -->
            </div>
        </main>

        <!-- Edit Modal -->
        <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto" onclick="closeModalOnBackdrop(event)">
            <div class="min-h-screen flex items-start justify-center p-2 pt-2 md:pt-4">
                <div class="bg-white rounded-lg w-full max-w-5xl min-h-[85vh] md:min-h-[80vh] max-h-[98vh] md:max-h-[95vh] overflow-hidden flex flex-col mt-2 md:mt-4 mb-2 md:mb-4" onclick="event.stopPropagation()">
                    <!-- Fixed Header -->
                    <div class="flex justify-between items-center p-4 bg-white border-b flex-shrink-0">
                        <h2 id="modalTitle" class="text-lg sm:text-xl font-bold">√âditer</h2>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-red-500 text-3xl font-bold leading-none w-12 h-12 flex items-center justify-center rounded-full hover:bg-gray-100">&times;</button>
                    </div>
                    
                    <!-- Scrollable Content -->
                    <div class="flex-1 overflow-y-auto p-6">
                    <form id="editForm" class="space-y-4">
                        <input type="hidden" id="itemId">
                        
                        <!-- Job Fields -->
                        <div class="jobFields">
                            <div class="bg-gray-50 p-4 rounded-lg space-y-4">
                                <h3 class="font-semibold text-lg">Informations principales</h3>
                                <input type="text" id="title" placeholder="Titre du poste" class="w-full p-3 border rounded">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <select id="department" class="p-3 border rounded">
                                        <option value="">S√©lectionner une cat√©gorie</option>
                                        <option value="Beach Pro Tour">Beach Pro Tour</option>
                                        <option value="Grands Prix Cyclistes">Grands Prix Cyclistes</option>
                                        <option value="Marathon Beneva 21K">Marathon Beneva 21K</option>
                                        <option value="UCI 2026">UCI 2026</option>
                                        <option value="Studio 76">Studio 76</option>
                                        <option value="Dock 619">Dock 619</option>
                                        <option value="21K de Montr√©al">21K de Montr√©al</option>
                                        <option value="Groupe Tonic">Groupe Tonic</option>
                                    </select>
                                    <input type="text" id="location" placeholder="Lieu de travail" class="p-3 border rounded">
                                    <input type="text" id="type" placeholder="Type (Temps plein, etc.)" class="p-3 border rounded">
                                    <input type="text" id="salary" placeholder="Salaire" class="p-3 border rounded">
                                    <input type="date" id="datePosted" placeholder="Date de publication" class="p-3 border rounded">
                                    <input type="text" id="deadline" placeholder="Date limite (ex: 28 juillet 2025)" class="p-3 border rounded">
                                </div>
                                <textarea id="summary" placeholder="R√©sum√© court (optionnel)" rows="2" class="w-full p-3 border rounded"></textarea>
                            </div>
                            
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-lg mb-2">Description compl√®te</h3>
                                <p class="text-sm text-gray-600 mb-3">
                                    Copiez-collez directement depuis Word. Le syst√®me cr√©era automatiquement les paragraphes et liens.
                                    <span class="block mt-1 text-green-600">‚úì Formatage pr√©serv√©: <strong>gras</strong>, <em>italique</em>, liens</span>
                                </p>
                                <textarea id="description" placeholder="Copiez-collez la description ici..." rows="15" class="w-full p-3 border rounded bg-white"
                                    oninput="validateContent()"
                                    onpaste="handlePaste(event, 'description')"></textarea>
                                <div id="descriptionPreview" class="mt-2 p-3 bg-gray-50 border rounded text-sm" style="display: none;">
                                    <strong>Aper√ßu du formatage:</strong> 
                                    <div id="descriptionPreviewText" class="mt-2 cms-content-preview"></div>
                                </div>
                            </div>
                        </div>

                        <!-- News Fields -->
                        <div class="newsFields hidden">
                            <div class="bg-gray-50 p-4 rounded-lg space-y-4">
                                <h3 class="font-semibold text-lg">Informations principales</h3>
                                <input type="text" id="newsTitle" placeholder="Titre du communiqu√©" class="w-full p-3 border rounded">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="date" id="date" placeholder="Date" class="p-3 border rounded">
                                    <select id="category" class="p-3 border rounded">
                                        <option value="">S√©lectionner une cat√©gorie</option>
                                        <option value="Beach Pro Tour">Beach Pro Tour</option>
                                        <option value="Grands Prix Cyclistes">Grands Prix Cyclistes</option>
                                        <option value="Marathon Beneva 21K">Marathon Beneva 21K</option>
                                        <option value="UCI 2026">UCI 2026</option>
                                        <option value="Studio 76">Studio 76</option>
                                        <option value="Dock 619">Dock 619</option>
                                        <option value="21K de Montr√©al">21K de Montr√©al</option>
                                        <option value="Groupe Tonic">Groupe Tonic</option>
                                    </select>
                                </div>
                                <textarea id="newsSummary" placeholder="R√©sum√© court" rows="2" class="w-full p-3 border rounded"></textarea>
                            </div>
                            
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-lg mb-2">Contenu complet</h3>
                                <p class="text-sm text-gray-600 mb-3">
                                    Copiez-collez directement depuis Word. Le syst√®me cr√©era automatiquement les paragraphes et liens.
                                    <span class="block mt-1 text-green-600">‚úì Formatage pr√©serv√©: <strong>gras</strong>, <em>italique</em>, liens</span>
                                </p>
                                <textarea id="content" placeholder="Copiez-collez le contenu ici..." rows="15" class="w-full p-3 border rounded bg-white" 
                                    oninput="validateContent()"
                                    onpaste="handlePaste(event, 'content')"></textarea>
                                <div id="contentPreview" class="mt-2 p-3 bg-gray-50 border rounded text-sm" style="display: none;">
                                    <strong>Aper√ßu du formatage:</strong> 
                                    <div id="contentPreviewText" class="mt-2 cms-content-preview"></div>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-2 justify-end">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-100">
                                Annuler
                            </button>
                            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                Sauvegarder
                            </button>
                        </div>
                    </form>
                    </div> <!-- Close scrollable content div -->
                </div> <!-- Close modal content div -->
            </div> <!-- Close modal container div -->
        </div> <!-- Close modal wrapper div -->

    <!-- Custom Confirmation Dialog -->
    <div id="confirmDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 class="text-lg font-semibold mb-4">Confirmation</h3>
            <p id="confirmMessage" class="text-gray-700 mb-6"></p>
            <div class="flex gap-3 justify-end">
                <button id="confirmCancel" class="px-4 py-2 border rounded hover:bg-gray-100">
                    Annuler
                </button>
                <button id="confirmOK" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    Supprimer
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentType = 'jobs';
        let currentLang = 'fr';
        let currentData = [];

        // Simple password check
        const PASSWORD = 'admin123';
        
        // Debug logging system
        let debugMode = localStorage.getItem('debugMode') === 'true';
        
        function debugLog(message, data) {
            console.log(message, data);
            if (debugMode) {
                const debugLogEl = document.getElementById('debugLog');
                if (debugLogEl) {
                    const timestamp = new Date().toLocaleTimeString();
                    const entry = document.createElement('div');
                    entry.style.marginBottom = '5px';
                    entry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${message}`;
                    if (data !== undefined) {
                        entry.innerHTML += ` <span style="color: #ff0;">${JSON.stringify(data, null, 2)}</span>`;
                    }
                    debugLogEl.appendChild(entry);
                    debugLogEl.scrollTop = debugLogEl.scrollHeight;
                }
            }
        }
        
        function toggleDebugConsole() {
            const consoleEl = document.getElementById('debugConsole');
            debugMode = !debugMode;
            localStorage.setItem('debugMode', debugMode);
            if (consoleEl) {
                consoleEl.style.display = debugMode ? 'block' : 'none';
            }
            debugLog('Debug mode ' + (debugMode ? 'enabled' : 'disabled'));
        }
        
        function clearDebugConsole() {
            const debugLogEl = document.getElementById('debugLog');
            if (debugLogEl) {
                debugLogEl.innerHTML = '';
            }
        }
        
        // Initialize debug console state
        if (debugMode) {
            const consoleEl = document.getElementById('debugConsole');
            if (consoleEl) {
                consoleEl.style.display = 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            debugLog('üöÄ CMS Initialized');
            attachPasteHandlers();
            loadContent();
        });
        
        // Helper function to truncate HTML while preserving formatting
        function truncateHTML(html, maxLength) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            let textLength = 0;
            
            function truncateNode(node) {
                if (textLength >= maxLength) {
                    return '';
                }
                
                if (node.nodeType === Node.TEXT_NODE) {
                    const remainingLength = maxLength - textLength;
                    if (node.textContent.length <= remainingLength) {
                        textLength += node.textContent.length;
                        return node.textContent;
                    } else {
                        textLength = maxLength;
                        return node.textContent.substring(0, remainingLength) + '...';
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    const tagName = node.tagName.toLowerCase();
                    let result = `<${tagName}`;
                    
                    // Preserve important attributes
                    if (tagName === 'a' && node.href) {
                        result += ` href="${node.href}"`;
                        if (node.target) result += ` target="${node.target}"`;
                        if (node.style) result += ` style="${node.style.cssText}"`;
                    } else if (node.style && node.style.cssText) {
                        result += ` style="${node.style.cssText}"`;
                    }
                    
                    result += '>';
                    
                    // Process children
                    for (let child of node.childNodes) {
                        if (textLength >= maxLength) break;
                        result += truncateNode(child);
                    }
                    
                    result += `</${tagName}>`;
                    return result;
                }
                
                return '';
            }
            
            let result = '';
            for (let child of tempDiv.childNodes) {
                if (textLength >= maxLength) break;
                result += truncateNode(child);
            }
            
            return result;
        }
        
        // Strip HTML tags from text
        function stripHtml(html) {
            const tmp = document.createElement('DIV');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        // Simple and robust URL conversion
        function convertUrlsToLinks(text) {
            if (!text) return text;
            
            let result = text;
            
            // √âviter double processing
            if (result.includes('<a href=')) {
                return result;
            }
            
            console.log('üîó Converting URLs to links in text:', text.substring(0, 100));
            
            // 1. Email addresses (simple et robuste)
            result = result.replace(
                /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g,
                '<a href="mailto:$1" style="text-decoration: underline; color: #1d4ed8;">$1</a>'
            );
            
            // 2. URLs avec protocole
            result = result.replace(
                /(https?:\/\/[^\s<>"']+)/g,
                '<a href="$1" target="_blank" style="text-decoration: underline; color: #1d4ed8;">$1</a>'
            );
            
            // 3. Domaines www
            result = result.replace(
                /\b(www\.[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}[^\s<>"']*)/g,
                '<a href="https://$1" target="_blank" style="text-decoration: underline; color: #1d4ed8;">$1</a>'
            );
            
            console.log('‚úÖ URLs converted. Result length:', result.length);
            return result;
        }
        
        // Properly attach paste handlers (backup - HTML onpaste should work)
        function attachPasteHandlers() {
            const descriptionField = document.getElementById('description');
            const contentField = document.getElementById('content');
            
            if (descriptionField) {
                console.log('‚úÖ Description field found for paste handling');
            }
            
            if (contentField) {
                console.log('‚úÖ Content field found for paste handling');
            }
            
            // Test if handlePaste function exists
            if (typeof handlePaste === 'function') {
                console.log('‚úÖ handlePaste function is available');
            } else {
                console.error('‚ùå handlePaste function not found!');
            }
        }

        // Robust paste handler from your solution
        function handlePaste(event, fieldId) {
            debugLog('üî• PASTE EVENT TRIGGERED for field:', fieldId);
            
            const clipboardData = event.clipboardData || window.clipboardData;
            if (!clipboardData) {
                debugLog('‚ö†Ô∏è No clipboard data available');
                return;
            }
            
            const types = Array.from(clipboardData.types);
            debugLog('üìã Clipboard types:', types);
            
            let processedHTML = '';
            
            // Try HTML first
            if (clipboardData.types.includes('text/html')) {
                const htmlData = clipboardData.getData('text/html');
                debugLog('üìÑ HTML data length:', htmlData.length);
                if (htmlData && htmlData.trim().length > 0) {
                    processedHTML = processWordHTMLSimple(htmlData);
                    debugLog('‚úÖ Processed HTML length:', processedHTML.length);
                }
            }
            
            // Try plain text as fallback
            if (!processedHTML || processedHTML.trim().length === 0) {
                const rawText = clipboardData.getData('text/plain') || clipboardData.getData('text') || '';
                debugLog('üìù Plain text length:', rawText.length);
                if (rawText && rawText.trim().length > 0) {
                    processedHTML = processPlainTextSimple(rawText);
                    debugLog('‚úÖ Processed plain text length:', processedHTML.length);
                }
            }
            
            const textarea = document.getElementById(fieldId);
            if (!textarea) {
                debugLog('‚ùå Textarea not found:', fieldId);
                return;
            }
            
            // Process after browser paste
            setTimeout(() => {
                debugLog('‚è∞ Post-paste processing');
                
                let finalHTML = processedHTML;
                if (!finalHTML || finalHTML.trim().length === 0) {
                    const textareaContent = textarea.value;
                    if (textareaContent && textareaContent.trim().length > 0) {
                        finalHTML = convertTextToParagraphs(textareaContent);
                        debugLog('üìù Used textarea fallback');
                    }
                }
                
                // Store and show
                textarea.setAttribute('data-processed-content', finalHTML);
                showContentPreview(fieldId, finalHTML);
                
                debugLog('‚úÖ Paste complete, HTML stored:', finalHTML.substring(0, 100) + '...');
            }, 150);
        }

        // Helper function to escape regex special characters
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Advanced Word HTML processing - PRESERVES ALL FORMATTING
        function processWordHTMLSimple(html) {
            if (!html || html.trim().length === 0) return '';
            
            debugLog('üé® Processing Word HTML with FULL formatting preservation');
            
            try {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Remove only truly unwanted elements but keep formatting
                const unwanted = tempDiv.querySelectorAll('meta, script, xml, o\\:p');
                unwanted.forEach(el => el.remove());
                
                // Clean up Word-specific CSS but preserve visual formatting
                cleanWordFormatting(tempDiv);
                
                // Convert Word elements to proper HTML
                convertWordElements(tempDiv);
                
                // Get formatted HTML content
                let processedHTML = tempDiv.innerHTML;
                
                // Clean up extra whitespace but preserve intentional formatting
                processedHTML = processedHTML
                    .replace(/\s*<\/p>\s*<p[^>]*>\s*/g, '</p><p>')  // Clean paragraph spacing
                    .replace(/(<p[^>]*>)\s+/g, '$1')                // Remove leading spaces in paragraphs
                    .replace(/\s+(<\/p>)/g, '$1')                  // Remove trailing spaces in paragraphs
                    .replace(/\n\s*\n/g, '\n')                     // Remove excessive line breaks
                    .trim();
                
                debugLog('‚ú® Preserved formatted HTML length:', processedHTML.length);
                debugLog('üîó Links preserved:', (processedHTML.match(/<a /g) || []).length);
                debugLog('üí™ Bold text preserved:', (processedHTML.match(/<(strong|b)\b/g) || []).length);
                
                return processedHTML;
                
            } catch (error) {
                debugLog('‚ùå Error processing HTML:', error.message);
                return '';
            }
        }
        
        // Clean Word-specific formatting but preserve visual appearance
        function cleanWordFormatting(element) {
            // Remove Word-specific namespaces and attributes but keep visual styling
            const elementsToClean = element.querySelectorAll('*');
            elementsToClean.forEach(el => {
                // Remove Word-specific attributes
                el.removeAttribute('class');
                el.removeAttribute('lang');
                
                // Convert Word styling to standard CSS
                if (el.style) {
                    const style = el.style;
                    let newStyle = '';
                    
                    // Preserve important visual styles
                    if (style.fontWeight === 'bold' || style.fontWeight >= 700) {
                        if (el.tagName.toLowerCase() !== 'strong' && el.tagName.toLowerCase() !== 'b') {
                            const strong = document.createElement('strong');
                            strong.innerHTML = el.innerHTML;
                            el.parentNode.replaceChild(strong, el);
                            return;
                        }
                    }
                    
                    if (style.fontStyle === 'italic') {
                        if (el.tagName.toLowerCase() !== 'em' && el.tagName.toLowerCase() !== 'i') {
                            const em = document.createElement('em');
                            em.innerHTML = el.innerHTML;
                            el.parentNode.replaceChild(em, el);
                            return;
                        }
                    }
                    
                    // Preserve font size
                    if (style.fontSize) {
                        newStyle += `font-size: ${style.fontSize}; `;
                    }
                    
                    // Preserve color
                    if (style.color) {
                        newStyle += `color: ${style.color}; `;
                    }
                    
                    // Preserve text decoration
                    if (style.textDecoration) {
                        newStyle += `text-decoration: ${style.textDecoration}; `;
                    }
                    
                    if (newStyle) {
                        el.setAttribute('style', newStyle.trim());
                    } else {
                        el.removeAttribute('style');
                    }
                }
            });
        }
        
        // Convert Word-specific elements to standard HTML
        function convertWordElements(element) {
            // Convert <span> with bold styling to <strong>
            const boldSpans = element.querySelectorAll('span[style*="font-weight"]');
            boldSpans.forEach(span => {
                if (span.style.fontWeight === 'bold' || span.style.fontWeight >= 700) {
                    const strong = document.createElement('strong');
                    strong.innerHTML = span.innerHTML;
                    if (span.style.fontSize || span.style.color) {
                        let keepStyle = '';
                        if (span.style.fontSize) keepStyle += `font-size: ${span.style.fontSize}; `;
                        if (span.style.color) keepStyle += `color: ${span.style.color}; `;
                        if (keepStyle) strong.setAttribute('style', keepStyle.trim());
                    }
                    span.parentNode.replaceChild(strong, span);
                }
            });
            
            // Convert <span> with italic styling to <em>
            const italicSpans = element.querySelectorAll('span[style*="font-style: italic"]');
            italicSpans.forEach(span => {
                const em = document.createElement('em');
                em.innerHTML = span.innerHTML;
                span.parentNode.replaceChild(em, span);
            });
            
            // Ensure hyperlinks are preserved
            const links = element.querySelectorAll('a');
            links.forEach(link => {
                if (link.href) {
                    link.setAttribute('target', '_blank');
                    link.setAttribute('style', 'text-decoration: underline; color: #1d4ed8;');
                }
            });
        }
        }

        // Helper function to convert text to paragraphs
        function convertTextToParagraphs(text) {
            if (!text || text.trim().length === 0) return '';
            
            console.log('üìÑ Converting text to paragraphs. Length:', text.length);
            
            // Split on double line breaks first
            let paragraphs = text.split(/\n\s*\n+/);
            
            // If no clear paragraph breaks, split on single line breaks
            if (paragraphs.length <= 1) {
                paragraphs = text.split(/\n+/);
            }
            
            // Clean and filter paragraphs
            paragraphs = paragraphs
                .map(para => para.trim().replace(/\s+/g, ' '))
                .filter(para => para.length > 3);
            
            // If still no paragraphs, treat entire text as one paragraph
            if (paragraphs.length === 0) {
                paragraphs = [text.trim()];
            }
            
            // Convert to HTML and add links
            const result = paragraphs
                .map(para => {
                    const withLinks = convertUrlsToLinks(para);
                    return `<p>${withLinks}</p>`;
                })
                .join('\n');
            
            console.log('‚úÖ Converted to', paragraphs.length, 'paragraphs');
            return result;
        }

        // Simple and robust plain text processing
        function processPlainTextSimple(text) {
            if (!text || text.trim().length === 0) return '';
            
            console.log('üìù Processing plain text (simple and robust)');
            console.log('üìù Input text length:', text.length);
            console.log('üìù First 100 chars:', text.substring(0, 100));
            
            try {
                // Clean up text
                let cleanText = text
                    .replace(/\r\n/g, '\n')
                    .replace(/\r/g, '\n')
                    .replace(/[\u2018\u2019]/g, "'")
                    .replace(/[\u201C\u201D]/g, '"')
                    .replace(/\u2013/g, '-')
                    .replace(/\u2014/g, '‚Äî')
                    .replace(/\u2026/g, '...')
                    .replace(/\u00A0/g, ' ');
                
                // Convert to paragraphs
                const result = convertTextToParagraphs(cleanText);
                
                console.log('‚úÖ Plain text processing complete. Result length:', result.length);
                return result;
                
            } catch (error) {
                console.error('‚ùå Error processing plain text:', error);
                // Ultimate fallback
                return `<p>${text}</p>`;
            }
        }
        
        // Process Word HTML content
        function processWordHTML(html) {
            if (!html || html.trim().length === 0) return '';
            
            console.log('üîç Processing Word HTML');
            
            // Create temporary container
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Remove Word-specific elements safely
            const unwantedElements = tempDiv.querySelectorAll('meta, style, script, xml');
            unwantedElements.forEach(el => el.remove());
            
            // Process all elements to preserve formatting
            const processedHTML = processElementsRecursively(tempDiv);
            
            // Convert to proper paragraphs and clean up
            return cleanAndStructureParagraphs(processedHTML);
        }

        function processElementsRecursively(element) {
            let result = '';
            
            for (let node of element.childNodes) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent.trim();
                    if (text) {
                        result += text + ' ';
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    const tagName = node.tagName.toLowerCase();
                    const style = node.style || {};
                    const childContent = processElementsRecursively(node);
                    
                    if (!childContent.trim()) continue;
                    
                    // Handle different elements
                    if (tagName === 'p' || tagName === 'div') {
                        result += `\n${childContent}\n`;
                    } else if (tagName === 'br') {
                        result += '\n';
                    } else if (tagName === 'a' && node.href) {
                        result += `<a href="${node.href}" style="text-decoration: underline; color: #1d4ed8;" target="_blank">${childContent}</a>`;
                    } else if (tagName === 'strong' || tagName === 'b' || 
                               (style.fontWeight && (style.fontWeight === 'bold' || parseInt(style.fontWeight) >= 700))) {
                        result += `<strong>${childContent}</strong>`;
                    } else if (tagName === 'em' || tagName === 'i' || style.fontStyle === 'italic') {
                        result += `<em>${childContent}</em>`;
                    } else if (tagName.match(/^h[1-6]$/) || 
                               (style.fontSize && (parseInt(style.fontSize) > 14 || style.fontSize.includes('large')))) {
                        result += `<strong style="font-size: 1.2em; display: block; margin: 10px 0;">${childContent}</strong>`;
                    } else {
                        result += childContent;
                    }
                }
            }
            
            return result;
        }

        function cleanAndStructureParagraphs(html) {
            if (!html) return '';
            
            // Convert URLs and emails to links first
            html = convertUrlsToLinks(html);
            
            // Split into paragraphs based on line breaks
            const paragraphs = html.split(/\n\s*\n+/)
                .map(para => para.trim().replace(/\n+/g, ' ').replace(/\s+/g, ' '))
                .filter(para => para.length > 0);
            
            // Wrap non-HTML paragraphs in <p> tags
            return paragraphs.map(para => {
                // If already contains block elements, don't wrap
                if (para.includes('<strong style="font-size') || para.includes('<h')) {
                    return para;
                }
                return `<p>${para}</p>`;
            }).join('\n');
        }

        function processPlainText(text) {
            if (!text || text.trim().length === 0) return '';
            
            console.log('üìù Processing plain text');
            
            // Clean up Word special characters
            text = text.replace(/[\u2018\u2019]/g, "'") // Smart quotes
                        .replace(/[\u201C\u201D]/g, '"') // Smart quotes
                        .replace(/\u2013/g, '-') // En dash
                        .replace(/\u2014/g, '--') // Em dash
                        .replace(/\u2026/g, '...') // Ellipsis
                        .replace(/\u00A0/g, ' '); // Non-breaking space
            
            // Convert URLs and emails to links
            text = convertUrlsToLinks(text);
            
            // Split into paragraphs
            const paragraphs = text.split(/\n\s*\n+/)
                .map(para => para.trim().replace(/\n+/g, ' ').replace(/\s+/g, ' '))
                .filter(para => para.length > 10);
            
            // If no clear paragraphs, split on sentence patterns that indicate new paragraphs
            if (paragraphs.length <= 1 && text.length > 100) {
                const sentences = text.split(/(?<=[.!?])\s+(?=[A-Z√Ä√â√à√ä√ã√è√é√î√ñ√ô√ö√õ√ú≈∏√á])/);
                return sentences.map(sentence => `<p>${sentence.trim()}</p>`).join('\n');
            }
            
            return paragraphs.map(para => `<p>${para}</p>`).join('\n');
        }


        
        // Enhanced Word content processing
        function processWordContent(text) {
            if (!text || text.trim().length === 0) return '';
            
            // First, restore links that were marked during Word HTML cleaning
            text = text.replace(/__LINK__(.*?)__LINKURL__(.*?)__/g, '<a href="$2" style="text-decoration: underline; color: #1d4ed8;">$1</a>');
            
            // Clean up Word's special characters
            text = text.replace(/[\u2018\u2019]/g, "'"); // Smart quotes
            text = text.replace(/[\u201C\u201D]/g, '"'); // Smart quotes
            text = text.replace(/\u2013/g, '-'); // En dash
            text = text.replace(/\u2014/g, '--'); // Em dash
            text = text.replace(/\u2026/g, '...'); // Ellipsis
            text = text.replace(/\u00A0/g, ' '); // Non-breaking space
            
            // Convert URLs and emails to links
            text = convertUrlsToLinks(text);
            
            // Smart paragraph detection
            let paragraphs = [];
            
            // Split on clear paragraph indicators
            const sections = text.split(/\n\s*\n+/);
            
            sections.forEach(section => {
                // Further split on specific patterns that indicate new paragraphs
                const subParagraphs = section.split(/\n(?=[A-Z√Ä√â√à√ä√ã√è√é√î√ñ√ô√ö√õ√ú≈∏√á]|Montr√©al|COMMUNIQU√â|CONTACT|Pour |Apr√®s |Les |En |De |Le |La |Ce |Cette |Dans |Selon |Nous |Il |Elle |Contact|Tel|T√©l|Email|E-mail)/);
                
                subParagraphs.forEach(para => {
                    const cleanPara = para.trim()
                        .replace(/\n+/g, ' ')
                        .replace(/\s+/g, ' ')
                        .trim();
                    
                    if (cleanPara.length > 10) {
                        paragraphs.push(cleanPara);
                    }
                });
            });
            
            // If no paragraphs detected, treat entire text as one paragraph
            if (paragraphs.length === 0 && text.trim().length > 0) {
                paragraphs = [text.trim().replace(/\n+/g, ' ').replace(/\s+/g, ' ')];
            }
            
            // Convert to HTML paragraphs
            return paragraphs.map(para => `<p>${para}</p>`).join('\n');
        }
        
        // Enhanced show content preview with HTML truncation
        function showContentPreview(fieldId, content) {
            debugLog('üëÅÔ∏è Showing preview for:', fieldId);
            
            const previewDiv = document.getElementById(fieldId + 'Preview');
            const previewText = document.getElementById(fieldId + 'PreviewText');
            
            if (previewDiv && previewText && content) {
                // Use enhanced HTML truncation to preserve formatting
                const shortPreview = truncateHTML(content, 300);
                previewText.innerHTML = shortPreview;
                previewDiv.style.display = 'block';
                debugLog('‚úÖ Preview shown with formatting preserved');
            }
        }
        
        // Validate content from your solution
        function validateContent() {
            try {
                const contentField = document.getElementById('content');
                const descriptionField = document.getElementById('description');
                
                if (contentField && contentField.value) {
                    debugLog('üìù Content field:', contentField.value.length + ' chars');
                }
                if (descriptionField && descriptionField.value) {
                    debugLog('üìù Description field:', descriptionField.value.length + ' chars');
                }
            } catch (error) {
                debugLog('‚ùå Validate error:', error.message);
            }
        }

        // Sync mobile and desktop dropdowns
        function syncDropdowns() {
            const mobileContentType = document.getElementById('contentType');
            const desktopContentType = document.getElementById('contentTypeDesktop');
            const mobileLanguage = document.getElementById('language');
            const desktopLanguage = document.getElementById('languageDesktop');
            
            // Mobile content type change
            mobileContentType.addEventListener('change', (e) => {
                currentType = e.target.value;
                desktopContentType.value = e.target.value;
                toggleFieldVisibility();
                loadContent();
            });
            
            // Desktop content type change
            desktopContentType.addEventListener('change', (e) => {
                currentType = e.target.value;
                mobileContentType.value = e.target.value;
                toggleFieldVisibility();
                loadContent();
            });
            
            // Mobile language change
            mobileLanguage.addEventListener('change', (e) => {
                currentLang = e.target.value;
                desktopLanguage.value = e.target.value;
                loadContent();
            });
            
            // Desktop language change
            desktopLanguage.addEventListener('change', (e) => {
                currentLang = e.target.value;
                mobileLanguage.value = e.target.value;
                loadContent();
            });
        }
        
        // Initialize dropdown sync
        syncDropdowns();

        document.getElementById('editForm').addEventListener('submit', saveItem);

        function toggleFieldVisibility() {
            const jobFields = document.querySelector('.jobFields');
            const newsFields = document.querySelector('.newsFields');
            
            if (currentType === 'jobs') {
                jobFields.classList.remove('hidden');
                newsFields.classList.add('hidden');
            } else {
                jobFields.classList.add('hidden');
                newsFields.classList.remove('hidden');
            }
        }

        function logout() {
            window.location.href = '/admin/';
        }
        


        // Simple fetch with password authentication
        async function fetchWithAuth(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: {
                    'X-Admin-Password': PASSWORD,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (response.status === 401 || response.status === 403) {
                window.location.href = '/admin/';
                return null;
            }

            return response;
        }

        async function loadContent() {
            try {
                debugLog('üì° Loading content:', { type: currentType, lang: currentLang });
                
                const response = await fetchWithAuth(`/api/cms/${currentType}?lang=${currentLang}`);
                
                if (!response) return;

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                debugLog('üì¶ Received data:', data);
                
                currentData = currentType === 'jobs' ? data.jobs : data.news;
                displayContent(currentData);
            } catch (error) {
                debugLog('‚ùå Load error:', error.message);
            }
        }

        function displayContent(items) {
            const container = document.getElementById('content');
            
            if (!items || items.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun contenu</p>';
                return;
            }

            container.innerHTML = items.map(item => {
                if (currentType === 'jobs') {
                    // Show formatted HTML description (preserving bold, italic, links)
                    let descText = '';
                    if (item.description) {
                        // Use truncateHTML to preserve formatting while limiting length
                        descText = truncateHTML(item.description, 400);
                    }
                    
                    return `
                        <div class="bg-white rounded-lg shadow p-4 md:p-6">
                            <div class="block md:flex md:justify-between md:items-start">
                                <div class="w-full md:flex-1 md:pr-4">
                                    <h3 class="text-xl font-bold text-blue-600">${item.title || ''}</h3>
                                    <div class="text-sm text-gray-600 mt-2">
                                        <strong>Department:</strong> ${item.department || 'N/A'} | 
                                        <strong>Location:</strong> ${item.location || item.lieu || 'N/A'} | 
                                        <strong>Type:</strong> ${item.type || 'N/A'}
                                    </div>
                                    ${descText ? `<div class="mt-3 text-gray-700 border-l-4 border-blue-200 pl-4 text-sm leading-relaxed w-full">
                                        <strong>Description:</strong><br><div class="block mt-1 cms-content-preview">${descText}</div>
                                    </div>` : '<div class="mt-3 text-gray-500 italic">No description available</div>'}
                                </div>
                                <div class="flex gap-2 mt-4 md:mt-0 md:flex-col md:gap-2">
                                    <button onclick="editItem(${item.id})" class="bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600 flex-1 md:flex-none">
                                        √âditer
                                    </button>
                                    <button onclick="deleteItem(${item.id})" class="bg-red-500 text-white px-3 py-2 rounded text-sm hover:bg-red-600 flex-1 md:flex-none">
                                        Supprimer
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Show formatted HTML content (preserving bold, italic, links)
                    let contentText = '';
                    if (item.content) {
                        // Use truncateHTML to preserve formatting while limiting length
                        contentText = truncateHTML(item.content, 400);
                    }
                    
                    return `
                        <div class="bg-white rounded-lg shadow p-4 md:p-6">
                            <div class="block md:flex md:justify-between md:items-start">
                                <div class="w-full md:flex-1 md:pr-4">
                                    <h3 class="text-xl font-bold text-purple-600">${item.title || ''}</h3>
                                    <div class="text-sm text-gray-600 mt-2">
                                        <strong>Date:</strong> ${item.date || 'N/A'} | 
                                        <strong>Category:</strong> ${item.category || 'N/A'}
                                    </div>
                                    ${contentText ? `<div class="mt-3 text-gray-700 border-l-4 border-purple-200 pl-4 pr-2 text-sm leading-relaxed">
                                        <strong>Content:</strong><br><div class="block mt-1 cms-content-preview">${contentText}</div>
                                    </div>` : '<div class="mt-3 text-gray-500 italic">No content available</div>'}
                                </div>
                                <div class="flex gap-2 mt-4 md:mt-0 md:flex-col md:gap-2">
                                    <button onclick="editItem(${item.id})" class="bg-purple-500 text-white px-3 py-2 rounded text-sm hover:bg-purple-600 flex-1 md:flex-none">
                                        √âditer
                                    </button>
                                    <button onclick="deleteItem(${item.id})" class="bg-red-500 text-white px-3 py-2 rounded text-sm hover:bg-red-600 flex-1 md:flex-none">
                                        Supprimer
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        function showAddForm() {
            document.getElementById('modalTitle').textContent = 'Ajouter';
            document.getElementById('editForm').reset();
            document.getElementById('itemId').value = '';
            
            // Clear any stored processed content
            const descField = document.getElementById('description');
            const contentField = document.getElementById('content');
            if (descField) descField.removeAttribute('data-processed-content');
            if (contentField) contentField.removeAttribute('data-processed-content');
            
            toggleFieldVisibility();
            document.getElementById('editModal').classList.remove('hidden');
        }

        function editItem(id) {
            const item = currentData.find(i => i.id == id);
            if (!item) return;

            document.getElementById('modalTitle').textContent = '√âditer';
            document.getElementById('itemId').value = id;

            if (currentType === 'jobs') {
                document.getElementById('title').value = item.title || '';
                document.getElementById('department').value = item.department || '';
                document.getElementById('location').value = item.location || item.lieu || '';
                document.getElementById('type').value = item.type || '';
                document.getElementById('salary').value = item.salary || item.salaire || '';
                document.getElementById('datePosted').value = item.datePosted || '';
                document.getElementById('deadline').value = item.deadline || '';
                document.getElementById('summary').value = item.summary || '';
                
                // Convert HTML to plain text for editing
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = item.description || '';
                const plainText = tempDiv.textContent || tempDiv.innerText || '';
                const descField = document.getElementById('description');
                descField.value = plainText;
                
                // Clear any stored processed content and store the original HTML
                descField.removeAttribute('data-processed-content');
                if (item.description) {
                    descField.setAttribute('data-processed-content', item.description);
                }
            } else {
                document.getElementById('newsTitle').value = item.title || '';
                document.getElementById('date').value = item.date || '';
                document.getElementById('category').value = item.category || '';
                document.getElementById('newsSummary').value = item.summary || '';
                
                // Convert HTML to plain text for editing
                const tempDiv2 = document.createElement('div');
                tempDiv2.innerHTML = item.content || '';
                const plainText = tempDiv2.textContent || tempDiv2.innerText || '';
                const contentField = document.getElementById('content');
                contentField.value = plainText;
                
                // Clear any stored processed content and store the original HTML
                contentField.removeAttribute('data-processed-content');
                if (item.content) {
                    contentField.setAttribute('data-processed-content', item.content);
                }
            }

            toggleFieldVisibility();
            document.getElementById('editModal').classList.remove('hidden');
        }

        async function saveItem(e) {
            e.preventDefault();
            
            try {
                const id = document.getElementById('itemId').value;
                const isNew = !id;
                
                let data = { lang: currentLang };
                
                if (currentType === 'jobs') {
                    const descTextarea = document.getElementById('description');
                    if (!descTextarea) {
                        console.error('‚ùå Description textarea not found!');
                        throw new Error('Description field not found');
                    }
                    
                    const descText = descTextarea.value || '';
                    
                    // Use processed content if available, otherwise process the raw text
                    let descHtml = descTextarea.getAttribute('data-processed-content');
                    if (!descHtml || descHtml.trim() === '') {
                        debugLog('üîß Processing raw description text:', descText.length + ' chars');
                        descHtml = processPlainTextSimple(descText);
                    }
                    
                    // Final fallback if still empty
                    if (!descHtml || descHtml.trim().length === 0) {
                        descHtml = descText ? convertTextToParagraphs(descText) : '';
                        debugLog('‚ö†Ô∏è Used fallback processing for description');
                    }
                    
                    debugLog('üíº Job description - Raw length:', descText.length + ', Processed length: ' + descHtml.length);
                    
                    data = {
                        ...data,
                        title: document.getElementById('title').value,
                        department: document.getElementById('department').value,
                        location: document.getElementById('location').value,
                        type: document.getElementById('type').value,
                        salary: document.getElementById('salary').value,
                        datePosted: document.getElementById('datePosted').value,
                        deadline: document.getElementById('deadline').value,
                        summary: convertUrlsToLinks(document.getElementById('summary').value),
                        description: descHtml
                    };
                } else {
                    const contentTextarea = document.getElementById('content');
                    if (!contentTextarea) {
                        console.error('‚ùå Content textarea not found!');
                        throw new Error('Content field not found');
                    }
                    
                    const contentText = contentTextarea.value || '';
                    
                    // Use processed content if available, otherwise process the raw text
                    let contentHtml = contentTextarea.getAttribute('data-processed-content');
                    if (!contentHtml || contentHtml.trim() === '') {
                        debugLog('üîß Processing raw content text:', contentText.length + ' chars');
                        contentHtml = processPlainTextSimple(contentText);
                    }
                    
                    // Final fallback if still empty
                    if (!contentHtml || contentHtml.trim().length === 0) {
                        contentHtml = contentText ? convertTextToParagraphs(contentText) : '';
                        debugLog('‚ö†Ô∏è Used fallback processing for content');
                    }
                    
                    debugLog('üì∞ News content - Raw length:', contentText.length + ', Processed length: ' + contentHtml.length);
                    
                    data = {
                        ...data,
                        title: document.getElementById('newsTitle').value,
                        date: document.getElementById('date').value,
                        category: document.getElementById('category').value,
                        summary: convertUrlsToLinks(document.getElementById('newsSummary').value),
                        content: contentHtml
                    };
                }

                debugLog('üíæ Saving data:', data);
                
                const url = isNew 
                    ? `/api/cms/${currentType}` 
                    : `/api/cms/${currentType}/${id}`;
                
                const response = await fetchWithAuth(url, {
                    method: isNew ? 'POST' : 'PUT',
                    body: JSON.stringify(data)
                });

                if (!response) return; // Already handled redirect

                console.log('üì° Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Response error:', errorText);
                    throw new Error(`Save failed: ${response.status} ${errorText}`);
                }
                
                // Clear processed content attributes after successful save
                const descField = document.getElementById('description');
                const contentField = document.getElementById('content');
                if (descField) descField.removeAttribute('data-processed-content');
                if (contentField) contentField.removeAttribute('data-processed-content');
                
                closeModal();
                await loadContent();
                alert(isNew ? '‚úÖ Cr√©√© avec succ√®s' : '‚úÖ Modifi√© avec succ√®s');
            } catch (error) {
                console.error('‚ùå Save error:', error);
                console.error('‚ùå Error details:', error.message, error.stack);
                alert(`‚ùå Erreur de sauvegarde: ${error.message || 'Erreur inconnue'}`);
            }
        }

        // Test function to verify paste handling works
        function testPasteHandling() {
            console.log('üß™ Testing paste handling...');
            
            // Test text with links and paragraphs
            const testText = `Voici un test avec un lien vers https://example.com et un email test@example.com.

Ceci est un deuxi√®me paragraphe avec du texte en **gras**.

Pour plus d'informations, visitez www.groupetonic.com.`;
            
            // Simulate processing
            const processed = processWordContent(testText);
            console.log('üìù Original text:', testText);
            console.log('üîß Processed HTML:', processed);
            
            // Test link conversion
            const withLinks = convertUrlsToLinks(testText);
            console.log('üîó With links:', withLinks);
        }

        async function deleteItem(id) {
            if (!await showConfirmDialog('√ätes-vous s√ªr de vouloir supprimer cet √©l√©ment?')) return;

            try {
                const response = await fetchWithAuth(`/api/cms/${currentType}/${id}?lang=${currentLang}`, {
                    method: 'DELETE'
                });

                if (!response) return; // Already handled redirect
                if (!response.ok) throw new Error('Delete failed');
                
                loadContent();
                alert('Supprim√© avec succ√®s');
            } catch (error) {
                console.error('Error:', error);
                alert('Erreur de suppression');
            }
        }

        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
        }
        
        function closeModalOnBackdrop(event) {
            if (event.target === event.currentTarget) {
                closeModal();
            }
        }

        // Custom confirmation dialog
        function showConfirmDialog(message) {
            return new Promise((resolve) => {
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmDialog').classList.remove('hidden');
                
                document.getElementById('confirmOK').onclick = () => {
                    document.getElementById('confirmDialog').classList.add('hidden');
                    resolve(true);
                };
                
                document.getElementById('confirmCancel').onclick = () => {
                    document.getElementById('confirmDialog').classList.add('hidden');
                    resolve(false);
                };
            });
        }

        // Helper functions for HTML editing
        function insertTag(tag) {
            const textarea = document.getElementById('description');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const replacement = `<${tag}>${selectedText}</${tag}>`;
            
            textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + tag.length + 2, start + tag.length + 2 + selectedText.length);
        }

        function insertList() {
            const textarea = document.getElementById('description');
            const start = textarea.selectionStart;
            const listTemplate = '<ul>\n  <li></li>\n  <li></li>\n  <li></li>\n</ul>';
            
            textarea.value = textarea.value.substring(0, start) + listTemplate + textarea.value.substring(start);
            textarea.focus();
            textarea.setSelectionRange(start + 9, start + 9);
        }

        // Load initial content
        toggleFieldVisibility();
        
        // Check initial content type and show department filter if needed
        if (document.getElementById('contentType').value === 'news') {
            document.getElementById('departmentFilter').style.display = 'block';
        }
        
        function logout() {
            localStorage.removeItem('cmsAuth');
            location.reload();
        }
        
        // Diagnostic functions for checking content formatting
        function checkContent() {
            console.log('üîç DIAGNOSTIC: Checking all content formatting...');
            if (!currentData || currentData.length === 0) {
                console.log('‚ùå No data loaded');
                return;
            }
            
            currentData.forEach((item, index) => {
                const content = currentType === 'jobs' ? item.description : item.content;
                const isHTML = content && (content.includes('<p>') || content.includes('<strong>') || content.includes('<a'));
                console.log(`Item ${index + 1}: "${item.title}" - ${isHTML ? '‚úÖ Has HTML' : '‚ùå Plain text'}`);
                if (!isHTML && content) {
                    console.log(`  Raw content: "${content.substring(0, 100)}..."`);
                }
            });
        }
        
        function showRawContent(index) {
            if (!currentData || !currentData[index]) {
                console.log('‚ùå Item not found');
                return;
            }
            const item = currentData[index];
            const content = currentType === 'jobs' ? item.description : item.content;
            console.log(`Raw content for "${item.title}":`, content);
        }
        
        function needsFormatting() {
            console.log('üîç Items that need formatting:');
            if (!currentData) return;
            
            currentData.forEach((item, index) => {
                const content = currentType === 'jobs' ? item.description : item.content;
                const isHTML = content && (content.includes('<p>') || content.includes('<strong>') || content.includes('<a'));
                if (!isHTML && content) {
                    console.log(`${index + 1}. "${item.title}" - needs formatting`);
                }
            });
        }
        
        function reprocessAllContent() {
            console.log('üîÑ Refreshing display...');
            displayContent(currentData);
        }
        
        // Auto-fix plain text content by adding basic HTML paragraph tags
        async function autoFixPlainTextContent() {
            console.log('üîÑ STARTING AUTO-FIX: Converting plain text to HTML...');
            
            if (!currentData || currentData.length === 0) {
                console.log('‚ùå No data to fix');
                return;
            }
            
            let fixedCount = 0;
            
            for (let i = 0; i < currentData.length; i++) {
                const item = currentData[i];
                const contentField = currentType === 'jobs' ? 'description' : 'content';
                const content = item[contentField];
                
                // Check if content needs fixing (is plain text)
                const isHTML = content && (content.includes('<p>') || content.includes('<strong>') || content.includes('<a'));
                
                if (content && !isHTML) {
                    console.log(`üîß Fixing item ${i + 1}: "${item.title}"`);
                    
                    // Convert plain text to HTML paragraphs
                    const htmlContent = processTextToParagraphs(content);
                    
                    // Prepare the update data
                    const updateData = {
                        ...item,
                        [contentField]: htmlContent
                    };
                    
                    try {
                        // Save the updated item
                        const response = await fetchWithAuth(`/api/cms/${currentType}/${item.id}?lang=${currentLang}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(updateData)
                        });
                        
                        if (response && response.ok) {
                            fixedCount++;
                            console.log(`‚úÖ Fixed "${item.title}"`);
                        } else {
                            console.error(`‚ùå Failed to fix "${item.title}"`);
                        }
                    } catch (error) {
                        console.error(`‚ùå Error fixing "${item.title}":`, error);
                    }
                }
            }
            
            console.log(`üéâ AUTO-FIX COMPLETE: Fixed ${fixedCount} items`);
            
            // Reload content to show the changes
            await loadContent();
            alert(`‚úÖ Auto-fix termin√©! ${fixedCount} √©l√©ments convertis en HTML.`);
        }
        
        // Helper function to convert plain text to HTML paragraphs
        function processTextToParagraphs(text) {
            if (!text) return '';
            
            // Split by double line breaks (paragraph breaks)
            const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim());
            
            // Convert each paragraph to HTML
            const htmlParagraphs = paragraphs.map(paragraph => {
                // Clean up the paragraph
                const cleaned = paragraph.trim().replace(/\n/g, ' ');
                
                // Convert URLs to links
                const withLinks = convertUrlsToLinks(cleaned);
                
                return `<p>${withLinks}</p>`;
            });
            
            return htmlParagraphs.join('\n\n');
        }
    </script>
</body>
</html>