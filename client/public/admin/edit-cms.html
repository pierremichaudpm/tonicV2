<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS - Groupe Tonic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        
        .card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .cms-content-preview { 
            line-height: 1.6; 
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
        }
        .cms-content-preview p { margin: 0.5em 0; }
        .cms-content-preview h1 { font-size: 2em; font-weight: bold; margin: 0.67em 0; }
        .cms-content-preview h2 { font-size: 1.5em; font-weight: bold; margin: 0.83em 0; }
        .cms-content-preview h3 { font-size: 1.17em; font-weight: bold; margin: 1em 0; }
        .cms-content-preview ul, .cms-content-preview ol { margin: 0.5em 0; padding-left: 2em; }
        .cms-content-preview li { margin: 0.25em 0; }
        .cms-content-preview strong { font-weight: bold; color: #fff; }
        .cms-content-preview em { font-style: italic; }
        .cms-content-preview a { color: #3b82f6; text-decoration: underline; }
        .cms-content-preview a:hover { color: #1d4ed8; }
    </style>
</head>
<body class="min-h-screen text-white">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-black/20 border-b border-white/10 p-4">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold">Groupe Tonic</h1>
                <div class="flex gap-4 items-center">
                    <select id="languageToggle" class="bg-white/10 border border-white/20 rounded px-3 py-1 text-white">
                        <option value="fr">Fran√ßais</option>
                        <option value="en">English</option>
                    </select>
                    <button onclick="logout()" class="text-red-400 hover:text-red-300">D√©connexion</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-4">
            <div class="max-w-6xl mx-auto">
                <!-- Navigation Tabs -->
                <div class="flex gap-4 mb-6">
                    <button onclick="showSection('jobs')" id="jobsTab" class="px-4 py-2 rounded-lg btn-primary">
                        Emplois
                    </button>
                    <button onclick="showSection('news')" id="newsTab" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20">
                        Communiqu√©s
                    </button>
                </div>

                <!-- Jobs Section -->
                <div id="jobsSection" class="section-content">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Gestion des Emplois</h2>
                        <button onclick="showAddForm('jobs')" class="btn-primary px-4 py-2 rounded-lg">
                            Ajouter un emploi
                        </button>
                    </div>
                    <div id="jobsList" class="space-y-4">
                        <!-- Jobs will be loaded here -->
                    </div>
                </div>

                <!-- News Section -->
                <div id="newsSection" class="section-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Gestion des Communiqu√©s</h2>
                        <button onclick="showAddForm('news')" class="btn-primary px-4 py-2 rounded-lg">
                            Ajouter un communiqu√©
                        </button>
                    </div>
                    <div id="newsList" class="space-y-4">
                        <!-- News will be loaded here -->
                    </div>
                </div>

                <!-- Add/Edit Form Modal -->
                <div id="formModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50">
                    <div class="flex items-start justify-center min-h-screen p-4 py-8">
                        <div class="card w-full max-w-4xl max-h-[90vh] rounded-xl overflow-hidden flex flex-col">
                            <!-- Fixed Header -->
                            <div class="flex justify-between items-center p-6 border-b border-white/10">
                                <h3 id="formTitle" class="text-xl font-semibold">Ajouter</h3>
                                <button onclick="hideForm()" class="text-gray-400 hover:text-white">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            <!-- Scrollable Form Content -->
                            <div class="flex-1 overflow-y-auto p-6">
                                <form id="contentForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Titre</label>
                                    <input type="text" id="title" class="w-full p-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400" required>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-2">Date</label>
                                    <input type="date" id="date" class="w-full p-3 bg-white/10 border border-white/20 rounded-lg text-white" required>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-2">Cat√©gorie</label>
                                    <select id="category" class="w-full p-3 bg-white/10 border border-white/20 rounded-lg text-white" required>
                                        <option value="">S√©lectionner une cat√©gorie</option>
                                        <option value="Beach Pro Tour">Beach Pro Tour</option>
                                        <option value="Grands Prix Cyclistes">Grands Prix Cyclistes</option>
                                        <option value="Marathon Beneva 21K">Marathon Beneva 21K</option>
                                        <option value="UCI 2026">UCI 2026</option>
                                        <option value="Studio 76">Studio 76</option>
                                        <option value="Dock 619">Dock 619</option>
                                        <option value="21K de Montr√©al">21K de Montr√©al</option>
                                        <option value="Groupe Tonic">Groupe Tonic</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-2">R√©sum√©</label>
                                    <textarea id="summary" rows="3" class="w-full p-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400" required></textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-2">Contenu</label>
                                    <div class="bg-yellow-900/30 border border-yellow-700/50 rounded-lg p-3 mb-2">
                                        <p class="text-yellow-200 text-sm">
                                            üìù <strong>Collage depuis Word:</strong> Copiez-collez directement depuis Word. 
                                            Le formatage (gras, italique, liens) sera automatiquement pr√©serv√©.
                                        </p>
                                    </div>
                                    <textarea id="content" rows="15" 
                                              class="w-full p-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 resize-none" 
                                              onpaste="handlePaste(event, 'content')"
                                              placeholder="Collez votre contenu Word ici..." required></textarea>
                                    <div id="contentPreview" class="cms-content-preview hidden max-h-60 overflow-y-auto">
                                        <div class="text-sm text-gray-400 mb-2">Aper√ßu du formatage:</div>
                                        <div id="contentPreviewText"></div>
                                    </div>
                                </div>
                                </form>
                            </div>

                            <!-- Fixed Footer with Buttons -->
                            <div class="border-t border-white/10 p-6">
                                <div class="flex gap-4 justify-end">
                                    <button type="button" onclick="hideForm()" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg">
                                        Annuler
                                    </button>
                                    <button type="button" onclick="saveCurrentItem()" class="px-6 py-2 btn-primary rounded-lg">
                                        Enregistrer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Login Modal -->
                <div id="loginModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center">
                    <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-8 w-full max-w-md mx-4">
                        <h2 class="text-2xl font-bold text-center mb-6">Connexion CMS</h2>
                        <form id="loginForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Mot de passe</label>
                                <input type="password" id="password" class="w-full p-3 bg-white/10 border border-white/20 rounded-lg text-white" placeholder="Entrez le mot de passe" required>
                            </div>
                            <button type="submit" class="w-full btn-primary py-3 rounded-lg font-medium">
                                Se connecter
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize system
        let currentType = 'jobs';
        let currentLang = 'fr';
        let currentEditId = null;
        let isAuthenticated = false;

        // Enhanced Word Processor Class
        class WordProcessor {
            constructor() {
                this.styleToTag = {
                    'bold': 'strong',
                    'italic': 'em',
                    'underline': 'u'
                };
            }

            processContent(clipboardData, fieldId) {
                let processedHTML = '';
                
                if (clipboardData.types.includes('text/html')) {
                    const htmlData = clipboardData.getData('text/html');
                    if (htmlData && htmlData.trim()) {
                        processedHTML = this.processWordHTML(htmlData);
                    }
                }
                
                if (!processedHTML && clipboardData.types.includes('text/plain')) {
                    const textData = clipboardData.getData('text/plain');
                    if (textData && textData.trim()) {
                        processedHTML = this.processPlainText(textData);
                    }
                }
                
                return processedHTML;
            }

            processWordHTML(html) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                this.cleanWordElements(tempDiv);
                
                const blocks = [];
                this.processNode(tempDiv, blocks);
                
                return blocks.join('\n').trim();
            }

            cleanWordElements(container) {
                const wordElements = container.querySelectorAll('meta, link, style, xml, o\\:p, script, colgroup, col');
                wordElements.forEach(el => el.remove());
                
                const walker = document.createTreeWalker(
                    container,
                    NodeFilter.SHOW_COMMENT,
                    null,
                    false
                );
                const comments = [];
                while (walker.nextNode()) {
                    comments.push(walker.currentNode);
                }
                comments.forEach(comment => comment.remove());
                
                const allElements = container.querySelectorAll('*');
                allElements.forEach(el => {
                    const keepAttrs = ['href', 'src', 'colspan', 'rowspan'];
                    Array.from(el.attributes).forEach(attr => {
                        if (!keepAttrs.includes(attr.name) && !attr.name.startsWith('data-')) {
                            el.removeAttribute(attr.name);
                        }
                    });
                });
            }

            processNode(node, blocks, inlineFormatting = []) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent.replace(/\s+/g, ' ').trim();
                    if (text) {
                        return this.applyInlineFormatting(text, inlineFormatting);
                    }
                    return '';
                }
                
                if (node.nodeType === Node.ELEMENT_NODE) {
                    const tag = node.tagName.toLowerCase();
                    const style = window.getComputedStyle(node);
                    
                    if (this.isBlockElement(tag)) {
                        const blockContent = this.processBlockElement(node, tag, style);
                        if (blockContent) {
                            blocks.push(blockContent);
                        }
                        return '';
                    }
                    
                    return this.processInlineElement(node, tag, style, inlineFormatting);
                }
                
                return '';
            }

            isBlockElement(tag) {
                const blockTags = ['p', 'div', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'li', 'table', 'tr', 'td', 'th', 'blockquote'];
                return blockTags.includes(tag);
            }

            processBlockElement(node, tag, style) {
                if (tag.match(/^h[1-6]$/)) {
                    const content = this.extractInlineContent(node);
                    return content ? `<${tag}>${content}</${tag}>` : '';
                }
                
                if (tag === 'ul' || tag === 'ol') {
                    const items = Array.from(node.querySelectorAll(':scope > li'))
                        .map(li => {
                            const content = this.extractInlineContent(li);
                            return content ? `<li>${content}</li>` : '';
                        })
                        .filter(item => item);
                    
                    return items.length ? `<${tag}>\n${items.join('\n')}\n</${tag}>` : '';
                }
                
                if (tag === 'p' || tag === 'div') {
                    const content = this.extractInlineContent(node);
                    
                    if (!content) return '';
                    
                    // ENHANCED PARAGRAPH SPLITTING LOGIC
                    // Check if this is a mega-paragraph (very long content in single <p>)
                    if (content.length > 500 && !content.includes('</p>')) {
                        console.log('üî• Splitting mega-paragraph intelligently');
                        
                        // Split on sentence endings followed by capital letters (French pattern)
                        let paragraphs = [];
                        let currentParagraph = '';
                        
                        // Split into sentences first
                        const sentences = content.split(/(?<=[.!?¬ª])\s+/);
                        
                        sentences.forEach((sentence, index) => {
                            currentParagraph += sentence + ' ';
                            
                            // Create new paragraph based on multiple criteria:
                            const nextSentence = sentences[index + 1] || '';
                            const shouldBreak = 
                                // 1. Next sentence starts with specific French patterns
                                /^(L'√©lite|L'√©nergie|Les |Le |La |Plus |Un |Une |Apr√®s |Suite |Pour |D√©clarations|CONTACT|√Ä propos)/.test(nextSentence) ||
                                // 2. Current sentence ends with closing quote and next starts with opening quote
                                (/¬ª$/.test(sentence.trim()) && /^¬´/.test(nextSentence)) ||
                                // 3. Next sentence starts with a date pattern
                                /^(Montr√©al|MONTR√âAL|Du |Le \d)/.test(nextSentence) ||
                                // 4. Every 2-3 sentences for very long content
                                (currentParagraph.length > 400 && /[.!?¬ª]$/.test(sentence.trim()));
                            
                            if (shouldBreak && currentParagraph.trim()) {
                                paragraphs.push(`<p>${currentParagraph.trim()}</p>`);
                                currentParagraph = '';
                            }
                        });
                        
                        // Add any remaining content
                        if (currentParagraph.trim()) {
                            paragraphs.push(`<p>${currentParagraph.trim()}</p>`);
                        }
                        
                        return paragraphs.join('\n');
                    }
                    
                    // For shorter content or already well-structured content
                    return `<p>${content}</p>`;
                }
                
                const content = this.extractInlineContent(node);
                return content ? `<p>${content}</p>` : '';
            }

            processInlineElement(node, tag, style, parentFormatting) {
                const formatting = [...parentFormatting];
                
                // Only apply bold for explicit HTML tags, not computed styles from Word
                if (tag === 'strong' || tag === 'b') {
                    formatting.push('strong');
                }
                if (tag === 'em' || tag === 'i' || style.fontStyle === 'italic') {
                    formatting.push('em');
                }
                if (tag === 'u' || style.textDecoration.includes('underline')) {
                    formatting.push('u');
                }
                
                if (tag === 'a' && node.href) {
                    const content = this.extractInlineContent(node, formatting);
                    return `<a href="${node.href}" target="_blank">${content}</a>`;
                }
                
                return this.extractInlineContent(node, formatting);
            }

            extractInlineContent(node, formatting = []) {
                let content = '';
                
                for (let child of node.childNodes) {
                    if (child.nodeType === Node.TEXT_NODE) {
                        const text = child.textContent.replace(/\s+/g, ' ');
                        if (text.trim()) {
                            content += this.applyInlineFormatting(text, formatting);
                        }
                    } else if (child.nodeType === Node.ELEMENT_NODE) {
                        content += this.processInlineElement(child, child.tagName.toLowerCase(), window.getComputedStyle(child), formatting);
                    }
                }
                
                return content.trim();
            }

            applyInlineFormatting(text, formatting) {
                if (!text || !formatting.length) return text;
                
                const uniqueFormats = [...new Set(formatting)];
                
                let result = text;
                uniqueFormats.forEach(format => {
                    result = `<${format}>${result}</${format}>`;
                });
                
                return result;
            }

            processPlainText(text) {
                text = text
                    .replace(/[\u2018\u2019]/g, "'")
                    .replace(/[\u201C\u201D]/g, '"')
                    .replace(/[\u2013]/g, '‚Äì')  // En dash
                    .replace(/[\u2014]/g, '‚Äî')  // Em dash
                    .replace(/\u2026/g, '...')
                    .replace(/\u00A0/g, ' ')
                    .replace(/[\u00AB]/g, '¬´ ') // Opening guillemet with space
                    .replace(/[\u00BB]/g, ' ¬ª') // Closing guillemet with space
                    .trim();
                
                text = this.convertUrlsToLinks(text);
                
                // ENHANCED PARAGRAPH DETECTION
                let paragraphs = [];
                
                // First try to split on double line breaks
                let chunks = text.split(/\n\s*\n+/);
                
                // If we only get one chunk, try to split intelligently
                if (chunks.length === 1 && text.length > 500) {
                    const longText = chunks[0];
                    let currentPara = '';
                    
                    // Split on sentences
                    const sentences = longText.split(/(?<=[.!?¬ª])\s+/);
                    
                    sentences.forEach((sentence, index) => {
                        currentPara += sentence + ' ';
                        const nextSentence = sentences[index + 1] || '';
                        
                        // Smart break detection
                        const shouldBreak = 
                            /^(Montr√©al|MONTR√âAL|L'√©lite|L'√©nergie|Les |Le |La |Plus |Un |Une |Apr√®s |Suite |Pour |D√©clarations|¬´ )/.test(nextSentence) ||
                            (/¬ª\s*$/.test(sentence) && /^¬´/.test(nextSentence)) ||
                            (currentPara.length > 400 && /[.!?¬ª]$/.test(sentence.trim()));
                        
                        if (shouldBreak && currentPara.trim()) {
                            paragraphs.push(currentPara.trim());
                            currentPara = '';
                        }
                    });
                    
                    if (currentPara.trim()) {
                        paragraphs.push(currentPara.trim());
                    }
                } else {
                    // Use the natural breaks
                    paragraphs = chunks.map(p => p.trim()).filter(p => p);
                }
                
                // Convert to HTML paragraphs
                return paragraphs.map(p => `<p>${p}</p>`).join('\n');
            }

            convertUrlsToLinks(text) {
                text = text.replace(
                    /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g,
                    '<a href="mailto:$1">$1</a>'
                );
                
                text = text.replace(
                    /(https?:\/\/[^\s<>"']+)(?![^<]*>|[^<>]*<\/a>)/g,
                    '<a href="$1" target="_blank">$1</a>'
                );
                
                text = text.replace(
                    /\b(www\.[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}[^\s<>"']*)(?![^<]*>|[^<>]*<\/a>)/g,
                    '<a href="https://$1" target="_blank">$1</a>'
                );
                
                return text;
            }
        }

        const wordProcessor = new WordProcessor();

        // Enhanced paste handling
        function handlePaste(event, fieldId) {
            event.preventDefault();
            
            const clipboardData = event.clipboardData || window.clipboardData;
            if (!clipboardData) return;
            
            console.log('üî• Enhanced paste handler triggered', fieldId);
            
            const processedHTML = wordProcessor.processContent(clipboardData, fieldId);
            
            if (processedHTML) {
                const textarea = document.getElementById(fieldId);
                if (!textarea) return;
                
                // Store the processed HTML
                textarea.setAttribute('data-processed-content', processedHTML);
                
                // IMPORTANT: Show plain text in textarea, not HTML!
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = processedHTML;
                textarea.value = tempDiv.textContent || tempDiv.innerText || '';
                
                // Show formatted preview
                showContentPreview(fieldId, processedHTML);
                
                console.log('‚úÖ Content processed successfully');
                console.log('üìÑ HTML stored:', processedHTML.substring(0, 200) + '...');
            }
        }

        // Show content preview
        function showContentPreview(fieldId, content) {
            const previewDiv = document.getElementById(fieldId + 'Preview');
            const previewText = document.getElementById(fieldId + 'PreviewText');
            
            if (previewDiv && previewText && content) {
                previewText.innerHTML = content;
                previewDiv.classList.remove('hidden');
                previewDiv.style.display = 'block';
                
                console.log('üëÅÔ∏è Preview updated with', content.split('<p>').length - 1, 'paragraphs');
            }
        }

        // Authentication
        async function login(password) {
            try {
                const response = await fetch('/api/cms/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password })
                });

                if (response.ok) {
                    isAuthenticated = true;
                    document.getElementById('loginModal').classList.add('hidden');
                    await loadContent();
                    return true;
                } else {
                    alert('Mot de passe incorrect');
                    return false;
                }
            } catch (error) {
                console.error('Erreur de connexion:', error);
                alert('Erreur de connexion');
                return false;
            }
        }

        function logout() {
            isAuthenticated = false;
            document.getElementById('loginModal').classList.remove('hidden');
        }

        // Load content
        async function loadContent() {
            if (!isAuthenticated) return;

            try {
                const endpoint = currentType === 'jobs' ? '/api/cms/jobs' : '/api/cms/news';
                const response = await fetch(endpoint, {
                    headers: { 'X-Admin-Password': 'admin123' }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayContent(data[currentType] || data.jobs || data.news || []);
                }
            } catch (error) {
                console.error('Erreur de chargement:', error);
            }
        }

        // Display content
        function displayContent(items) {
            const container = document.getElementById(currentType + 'List');
            if (!container) return;

            container.innerHTML = items.map(item => `
                <div class="card p-4 rounded-lg">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-lg">${item.title}</h3>
                        <div class="flex gap-2">
                            <button onclick="editItem(${item.id})" class="text-blue-400 hover:text-blue-300">
                                Modifier
                            </button>
                            <button onclick="deleteItem(${item.id})" class="text-red-400 hover:text-red-300">
                                Supprimer
                            </button>
                        </div>
                    </div>
                    <p class="text-gray-300 text-sm mb-2">${item.date} ‚Ä¢ ${item.category}</p>
                    <p class="text-gray-400">${item.summary}</p>
                </div>
            `).join('');
        }

        // Show section
        function showSection(type) {
            currentType = type;
            
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(type + 'Section').classList.remove('hidden');
            
            document.querySelectorAll('button[id$="Tab"]').forEach(tab => {
                tab.className = 'px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20';
            });
            document.getElementById(type + 'Tab').className = 'px-4 py-2 rounded-lg btn-primary';
            
            loadContent();
        }

        // Form handling
        function showAddForm(type) {
            currentType = type;
            currentEditId = null;
            document.getElementById('formTitle').textContent = type === 'jobs' ? 'Ajouter un emploi' : 'Ajouter un communiqu√©';
            document.getElementById('formModal').classList.remove('hidden');
            document.getElementById('contentForm').reset();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
        }

        function hideForm() {
            document.getElementById('formModal').classList.add('hidden');
            document.getElementById('contentPreview').style.display = 'none';
        }

        // Save current item (called by button)
        async function saveCurrentItem() {
            const form = document.getElementById('contentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            await saveItem();
        }

        // Save item
        async function saveItem(e) {
            if (e) e.preventDefault();
            
            const formData = {
                lang: currentLang,
                title: document.getElementById('title').value,
                date: document.getElementById('date').value,
                category: document.getElementById('category').value,
                summary: document.getElementById('summary').value,
                content: document.getElementById('content').getAttribute('data-processed-content') || document.getElementById('content').value
            };

            try {
                const endpoint = currentType === 'jobs' ? '/api/cms/jobs' : '/api/cms/news';
                const method = currentEditId ? 'PUT' : 'POST';
                const url = currentEditId ? `${endpoint}/${currentEditId}` : endpoint;
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': 'admin123'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    hideForm();
                    await loadContent();
                } else {
                    alert('Erreur lors de la sauvegarde');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la sauvegarde');
            }
        }

        // Delete item
        async function deleteItem(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet √©l√©ment ?')) return;

            try {
                const endpoint = currentType === 'jobs' ? '/api/cms/jobs' : '/api/cms/news';
                const response = await fetch(`${endpoint}/${id}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Password': 'admin123' }
                });

                if (response.ok) {
                    await loadContent();
                } else {
                    alert('Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la suppression');
            }
        }

        // Edit item
        async function editItem(id) {
            try {
                const endpoint = currentType === 'jobs' ? '/api/cms/jobs' : '/api/cms/news';
                const response = await fetch(endpoint, {
                    headers: { 'X-Admin-Password': 'admin123' }
                });

                if (response.ok) {
                    const data = await response.json();
                    const items = data[currentType] || data.jobs || data.news || [];
                    const item = items.find(i => i.id == id);
                    
                    if (item) {
                        currentEditId = id;
                        document.getElementById('formTitle').textContent = currentType === 'jobs' ? 'Modifier l\'emploi' : 'Modifier le communiqu√©';
                        document.getElementById('title').value = item.title;
                        document.getElementById('date').value = item.date;
                        document.getElementById('category').value = item.category;
                        document.getElementById('summary').value = item.summary;
                        // Show plain text in textarea
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = item.content;
                        document.getElementById('content').value = tempDiv.textContent || tempDiv.innerText || '';
                        
                        // Store the HTML
                        document.getElementById('content').setAttribute('data-processed-content', item.content);
                        
                        // Show the preview immediately
                        showContentPreview('content', item.content);
                        document.getElementById('formModal').classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // Test function for paragraph splitting
        window.testParagraphSplit = function() {
            const testText = `Montr√©al, le 17 juin 2025 ‚Äì Le plus haut niveau du volleyball de plage est de retour √† Montr√©al! Du 13 au 17 ao√ªt 2025, le Beach Pro Tour ‚Äì Elite transformera le l√©gendaire circuit Gilles-Villeneuve en une ar√®ne spectaculaire o√π s'affronteront les meilleures √©quipes f√©minines et masculines au monde. Apr√®s une √©dition 2023 marqu√©e par les victoires retentissantes des Canadiennes Melissa Humana-Paredes et Brandie Wilkerson, ainsi que des Norv√©giens Anders Mol et Christian S√∏rum, le tournoi s'annonce encore plus √©lectrisant cette ann√©e au Montr√©al Beach Pro Tour. Suite √† une spectaculaire m√©daille d'argent aux Jeux de Paris 2024, Humana-Paredes et Wilkerson reviennent √† Montr√©al en v√©ritables h√©ro√Ønes nationales du volleyball pour participer √† la seule √©tape canadienne de l'√©lite mondiale. L'√©nergie de Montr√©al. Les 32 meilleures √©quipes au monde s'affronteront pendant 5 jours pour gravier le classement international et Montr√©al est la seule occasion de le faire en territoire nord-am√©ricain sur le calendrier mondial 2025. Les Montr√©alaises et Montr√©alais ont donc une chance unique d'assister √† ces duels. Plus qu'un simple tournoi, Montr√©al Beach Pro Tour promet une ambiance survolt√©e : DJ sur place, zone gourmande et exp√©riences immersives. Un √©v√©nement festif qui marie sport de haut niveau, culture urbaine et plaisir estival. Les billets sont en vente d√®s maintenant! Rendez-vous sur mtlbeachprotour.com pour acc√©der aux meilleurs si√®ges pour vivre l'√©v√©nement au c≈ìur de l'action. D√©clarations ¬´ Montr√©al occupe une place bien sp√©ciale dans nos c≈ìurs, surtout depuis le succ√®s retentissant du dernier tournoi organis√© il y a deux ans ¬ª, a d√©clar√© Melissa Humana-Paredes.`;
            
            const processor = new WordProcessor();
            const result = processor.processPlainText(testText);
            
            console.log('Original length:', testText.length);
            console.log('Paragraphs created:', result.split('<p>').length - 1);
            console.log('Result:', result);
            
            // Show in preview if form is open
            if (document.getElementById('content')) {
                document.getElementById('content').value = testText;
                document.getElementById('content').setAttribute('data-processed-content', result);
                showContentPreview('content', result);
            }
            
            return result;
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ CMS Initialized');
            console.log('üí° Test paragraph splitting by running: testParagraphSplit()');
            
            // Login form
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const password = document.getElementById('password').value;
                login(password);
            });

            // Content form
            document.getElementById('contentForm').addEventListener('submit', saveItem);

            // Language toggle
            document.getElementById('languageToggle').addEventListener('change', function(e) {
                currentLang = e.target.value;
                loadContent();
            });

            // Show login modal
            if (!isAuthenticated) {
                document.getElementById('loginModal').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>