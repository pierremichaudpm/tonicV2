<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-6xl">
            <h1 class="text-2xl font-bold mb-6 text-center">CMS</h1>
            
            <div id="loginForm" class="mb-6">
                <input type="text" id="username" placeholder="Nom d'utilisateur" class="w-full p-3 border rounded mb-3">
                <input type="password" id="password" placeholder="Mot de passe" class="w-full p-3 border rounded mb-3">
                <button onclick="login()" class="w-full bg-blue-500 text-white p-3 rounded">Se connecter</button>
                <div id="error" class="text-red-500 mt-2 hidden"></div>
            </div>

            <div id="dashboard" class="hidden">
                <div class="flex mb-6">
                    <button onclick="showJobs()" class="bg-blue-500 text-white px-4 py-2 rounded mr-2" id="jobsBtn">Emplois</button>
                    <button onclick="showNews()" class="bg-green-500 text-white px-4 py-2 rounded mr-2" id="newsBtn">Actualités</button>
                    <select id="lang" onchange="loadData()" class="border p-2 rounded">
                        <option value="fr">Français</option>
                        <option value="en">English</option>
                    </select>
                    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded ml-auto">Déconnexion</button>
                </div>

                <div id="content" class="min-h-96">
                    <div id="loading" class="text-center text-gray-500 py-8">Chargement...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let token = null;
        let currentLang = 'fr';
        let currentView = 'jobs';
        let allJobs = [];
        let allNews = [];

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/cms/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    token = data.token;
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    await loadData();
                } else {
                    showError('Erreur de connexion');
                }
            } catch (error) {
                showError('Erreur de connexion');
            }
        }

        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').classList.remove('hidden');
        }

        function logout() {
            token = null;
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        function showJobs() {
            currentView = 'jobs';
            updateButtons();
            renderJobs();
        }

        function showNews() {
            currentView = 'news';
            updateButtons();
            renderNews();
        }

        function updateButtons() {
            document.getElementById('jobsBtn').className = currentView === 'jobs' 
                ? 'bg-blue-600 text-white px-4 py-2 rounded mr-2' 
                : 'bg-gray-300 text-gray-700 px-4 py-2 rounded mr-2';
            document.getElementById('newsBtn').className = currentView === 'news' 
                ? 'bg-green-600 text-white px-4 py-2 rounded mr-2' 
                : 'bg-gray-300 text-gray-700 px-4 py-2 rounded mr-2';
        }

        async function loadData() {
            const newLang = document.getElementById('lang').value;
            console.log('Language changed to:', newLang);
            currentLang = newLang;
            document.getElementById('loading').classList.remove('hidden');
            
            try {
                // Force fresh requests with timestamp
                const timestamp = Date.now();
                
                // Load jobs
                const jobsResponse = await fetch(`/api/cms/jobs?lang=${currentLang}&t=${timestamp}`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });
                if (jobsResponse.ok) {
                    const jobsData = await jobsResponse.json();
                    allJobs = jobsData.jobs || [];
                    console.log('Jobs loaded for', currentLang, ':', allJobs.length, 'items');
                }

                // Load news
                const newsResponse = await fetch(`/api/cms/news?lang=${currentLang}&t=${timestamp}`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });
                if (newsResponse.ok) {
                    const newsData = await newsResponse.json();
                    allNews = newsData.news || [];
                    console.log('News loaded for', currentLang, ':', allNews.length, 'items');
                }

                document.getElementById('loading').classList.add('hidden');
                
                // Force re-render with new data
                if (currentView === 'jobs') {
                    renderJobs();
                } else {
                    renderNews();
                }
            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').innerHTML = '<div class="text-red-500 text-center py-8">Erreur de chargement</div>';
            }
        }

        function renderJobs() {
            const langText = currentLang === 'fr' ? 'Français' : 'English';
            let html = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Emplois (${langText})</h2>
                    <button onclick="addJob()" class="bg-green-500 text-white px-4 py-2 rounded">Ajouter un emploi</button>
                </div>
            `;
            
            if (allJobs.length === 0) {
                html += '<p class="text-gray-500">Aucun emploi trouvé pour cette langue.</p>';
            } else {
                html += '<div class="grid gap-4">';
                allJobs.forEach(job => {
                    // Get full description content
                    const description = job.description || job.summary || job.content || 'Aucune description disponible';
                    
                    html += `
                        <div class="border p-4 rounded-lg bg-gray-50">
                            <h3 class="font-bold text-lg text-blue-600">${escapeHtml(job.title || 'Titre manquant')}</h3>
                            <div class="grid md:grid-cols-2 gap-2 mt-2 text-sm">
                                <p><strong>Département:</strong> ${escapeHtml(job.department || 'N/A')}</p>
                                <p><strong>Lieu:</strong> ${escapeHtml(job.location || job.lieu || 'N/A')}</p>
                                <p><strong>Type:</strong> ${escapeHtml(job.type || 'N/A')}</p>
                                <p><strong>Salaire:</strong> ${escapeHtml(job.salary || job.salaire || 'N/A')}</p>
                                <p><strong>Publié:</strong> ${escapeHtml(job.datePosted || 'N/A')}</p>
                                <p><strong>Échéance:</strong> ${escapeHtml(job.deadline || 'N/A')}</p>
                            </div>
                            <div class="mt-3 p-3 bg-white rounded border">
                                <p><strong>Description complète:</strong></p>
                                <p class="mt-1 text-sm leading-relaxed">${escapeHtml(description).replace(/\n/g, '<br>')}</p>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button onclick="editJob(${job.id})" class="bg-blue-500 text-white px-4 py-2 rounded text-sm">Modifier</button>
                                <button onclick="deleteJob(${job.id})" class="bg-red-500 text-white px-4 py-2 rounded text-sm">Supprimer</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            document.getElementById('content').innerHTML = html;
        }

        function renderNews() {
            const langText = currentLang === 'fr' ? 'Français' : 'English';
            let html = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Actualités (${langText})</h2>
                    <button onclick="addNews()" class="bg-green-500 text-white px-4 py-2 rounded">Ajouter une actualité</button>
                </div>
            `;
            
            if (allNews.length === 0) {
                html += '<p class="text-gray-500">Aucune actualité trouvée pour cette langue.</p>';
            } else {
                html += '<div class="grid gap-4">';
                allNews.forEach(article => {
                    // Get full content
                    const description = article.description || article.summary || article.content || 'Aucune description disponible';
                    
                    html += `
                        <div class="border p-4 rounded-lg bg-gray-50">
                            <h3 class="font-bold text-lg text-green-600">${escapeHtml(article.title || 'Titre manquant')}</h3>
                            <div class="grid md:grid-cols-2 gap-2 mt-2 text-sm">
                                <p><strong>Date:</strong> ${escapeHtml(article.date || 'N/A')}</p>
                                <p><strong>Catégorie:</strong> ${escapeHtml(article.category || article.section || 'N/A')}</p>
                            </div>
                            <div class="mt-3 p-3 bg-white rounded border">
                                <p><strong>Contenu complet:</strong></p>
                                <p class="mt-1 text-sm leading-relaxed">${escapeHtml(description).replace(/\n/g, '<br>')}</p>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button onclick="editNews(${article.id})" class="bg-green-500 text-white px-4 py-2 rounded text-sm">Modifier</button>
                                <button onclick="deleteNews(${article.id})" class="bg-red-500 text-white px-4 py-2 rounded text-sm">Supprimer</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            document.getElementById('content').innerHTML = html;
        }

        function editJob(jobId) {
            const job = allJobs.find(j => j.id == jobId);
            if (!job) return;

            const modal = createModal('Modifier l\'emploi', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Titre:</label>
                        <input type="text" id="editTitle" value="${escapeHtml(job.title || '')}" class="w-full p-2 border rounded">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Département:</label>
                            <input type="text" id="editDept" value="${escapeHtml(job.department || '')}" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Lieu:</label>
                            <input type="text" id="editLocation" value="${escapeHtml(job.location || job.lieu || '')}" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Type:</label>
                            <input type="text" id="editType" value="${escapeHtml(job.type || '')}" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Salaire:</label>
                            <input type="text" id="editSalary" value="${escapeHtml(job.salary || job.salaire || '')}" class="w-full p-2 border rounded">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Description:</label>
                        <textarea id="editDesc" class="w-full p-2 border rounded h-32">${escapeHtml(job.description || job.summary || '')}</textarea>
                    </div>
                </div>
            `, () => saveJob(job.id));
        }

        function editNews(newsId) {
            const article = allNews.find(n => n.id == newsId);
            if (!article) return;

            const modal = createModal('Modifier l\'actualité', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Titre:</label>
                        <input type="text" id="editTitle" value="${escapeHtml(article.title || '')}" class="w-full p-2 border rounded">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Date:</label>
                            <input type="date" id="editDate" value="${article.date || ''}" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Catégorie:</label>
                            <input type="text" id="editCategory" value="${escapeHtml(article.category || article.section || '')}" class="w-full p-2 border rounded">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Description:</label>
                        <textarea id="editDesc" class="w-full p-2 border rounded h-32">${escapeHtml(article.description || article.summary || article.content || '')}</textarea>
                    </div>
                </div>
            `, () => saveNews(article.id));
        }

        function createModal(title, content, onSave) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg w-full max-w-2xl max-h-96 overflow-y-auto m-4" onclick="event.stopPropagation()">
                    <h3 class="text-lg font-bold mb-4">${title}</h3>
                    ${content}
                    <div class="flex justify-end mt-6 gap-2">
                        <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded" onclick="this.closest('.fixed').remove()">Annuler</button>
                        <button type="button" class="bg-blue-500 text-white px-4 py-2 rounded" onclick="handleSave(this, () => (${onSave})())">Sauvegarder</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }

        async function handleSave(button, saveFunction) {
            try {
                await saveFunction();
                button.closest('.fixed').remove();
            } catch (error) {
                alert('Erreur lors de la sauvegarde');
            }
        }

        async function saveJob(jobId) {
            const job = allJobs.find(j => j.id == jobId);
            const data = {
                ...job,
                title: document.getElementById('editTitle').value,
                department: document.getElementById('editDept').value,
                location: document.getElementById('editLocation').value,
                type: document.getElementById('editType').value,
                salary: document.getElementById('editSalary').value,
                description: document.getElementById('editDesc').value,
                lang: currentLang
            };

            const response = await fetch(`/api/cms/jobs/${jobId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                await loadData();
            } else {
                throw new Error('Save failed');
            }
        }

        async function saveNews(newsId) {
            const article = allNews.find(n => n.id == newsId);
            const data = {
                ...article,
                title: document.getElementById('editTitle').value,
                date: document.getElementById('editDate').value,
                category: document.getElementById('editCategory').value,
                description: document.getElementById('editDesc').value,
                lang: currentLang
            };

            const response = await fetch(`/api/cms/news/${newsId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                await loadData();
            } else {
                throw new Error('Save failed');
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addJob() {
            const modal = createModal('Ajouter un emploi', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Titre:</label>
                        <input type="text" id="editTitle" placeholder="Titre du poste" class="w-full p-2 border rounded">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Département:</label>
                            <input type="text" id="editDept" placeholder="Administration, Événements, etc." class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Lieu:</label>
                            <input type="text" id="editLocation" placeholder="Montréal, QC" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Type:</label>
                            <input type="text" id="editType" placeholder="Temps plein, Temps partiel" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Salaire:</label>
                            <input type="text" id="editSalary" placeholder="Compétitif, 25$/heure" class="w-full p-2 border rounded">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Description:</label>
                        <textarea id="editDesc" placeholder="Description complète du poste" class="w-full p-2 border rounded h-32"></textarea>
                    </div>
                </div>
            `, () => saveNewJob());
        }

        function addNews() {
            const modal = createModal('Ajouter une actualité', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Titre:</label>
                        <input type="text" id="editTitle" placeholder="Titre de l'actualité" class="w-full p-2 border rounded">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Date:</label>
                            <input type="date" id="editDate" value="${new Date().toISOString().split('T')[0]}" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Catégorie:</label>
                            <input type="text" id="editCategory" placeholder="Beach Pro Tour, Marathon, etc." class="w-full p-2 border rounded">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Description:</label>
                        <textarea id="editDesc" placeholder="Contenu de l'actualité" class="w-full p-2 border rounded h-32"></textarea>
                    </div>
                </div>
            `, () => saveNewNews());
        }

        async function saveNewJob() {
            const data = {
                title: document.getElementById('editTitle').value,
                department: document.getElementById('editDept').value,
                location: document.getElementById('editLocation').value,
                type: document.getElementById('editType').value,
                salary: document.getElementById('editSalary').value,
                description: document.getElementById('editDesc').value,
                datePosted: new Date().toISOString().split('T')[0],
                lang: currentLang
            };

            const response = await fetch('/api/cms/jobs', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                await loadData();
            } else {
                throw new Error('Save failed');
            }
        }

        async function saveNewNews() {
            const data = {
                title: document.getElementById('editTitle').value,
                date: document.getElementById('editDate').value,
                category: document.getElementById('editCategory').value,
                description: document.getElementById('editDesc').value,
                lang: currentLang
            };

            const response = await fetch('/api/cms/news', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                await loadData();
            } else {
                throw new Error('Save failed');
            }
        }

        async function deleteJob(jobId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet emploi?')) {
                const response = await fetch(`/api/cms/jobs/${jobId}?lang=${currentLang}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    await loadData();
                } else {
                    alert('Erreur lors de la suppression');
                }
            }
        }

        async function deleteNews(newsId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette actualité?')) {
                const response = await fetch(`/api/cms/news/${newsId}?lang=${currentLang}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    await loadData();
                } else {
                    alert('Erreur lors de la suppression');
                }
            }
        }
    </script>
</body>
</html>