<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS Simple - Groupe Tonic</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">CMS Login</h1>
                <p class="text-gray-600">Groupe Tonic</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input 
                        type="password" 
                        id="loginPassword" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    >
                </div>
                
                <button 
                    type="submit" 
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
                >
                    Login
                </button>
            </form>
            
            <div id="loginError" class="mt-4 text-red-600 text-sm hidden"></div>
        </div>
    </div>

    <!-- CMS Dashboard -->
    <div id="dashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">CMS - Groupe Tonic</h1>
                <div class="flex items-center gap-4">
                    <select id="contentType" class="border rounded px-3 py-2">
                        <option value="jobs">Emplois / Jobs</option>
                        <option value="news">Actualités / News</option>
                    </select>
                    <select id="language" class="border rounded px-3 py-2">
                        <option value="fr">Français</option>
                        <option value="en">English</option>
                    </select>
                    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        Déconnexion
                    </button>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <main class="max-w-7xl mx-auto px-4 py-8">
            <div class="flex justify-between items-center mb-6">
                <h2 id="contentTitle" class="text-xl font-semibold">Emplois - Français</h2>
                <button onclick="showAddForm()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    + Ajouter
                </button>
            </div>

            <!-- Content List -->
            <div id="contentList" class="space-y-4">
                <!-- Content will be loaded here -->
            </div>
        </main>

        <!-- Edit Modal -->
        <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <h2 id="modalTitle" class="text-2xl font-bold mb-4">Éditer</h2>
                    <form id="editForm" class="space-y-4">
                        <input type="hidden" id="itemId">
                        
                        <!-- Job Fields -->
                        <div id="jobFields" class="space-y-4">
                            <input type="text" id="title" placeholder="Titre du poste" class="w-full p-3 border rounded">
                            <div class="grid grid-cols-2 gap-4">
                                <select id="department" class="p-3 border rounded">
                                    <option value="">Sélectionner un département</option>
                                </select>
                                <input type="text" id="location" placeholder="Lieu" class="p-3 border rounded">
                                <input type="text" id="type" placeholder="Type" class="p-3 border rounded">
                                <input type="text" id="salary" placeholder="Salaire" class="p-3 border rounded">
                            </div>
                            <textarea id="description" placeholder="Description" rows="8" class="w-full p-3 border rounded"></textarea>
                        </div>

                        <!-- News Fields -->
                        <div id="newsFields" class="space-y-4 hidden">
                            <input type="text" id="newsTitle" placeholder="Titre" class="w-full p-3 border rounded">
                            <div class="grid grid-cols-2 gap-4">
                                <input type="date" id="date" class="p-3 border rounded">
                                <select id="category" class="p-3 border rounded">
                                    <option value="">Sélectionner une catégorie</option>
                                </select>
                            </div>
                            <input type="hidden" id="image" style="display: none !important;">
                            <textarea id="summary" placeholder="Résumé" rows="3" class="w-full p-3 border rounded"></textarea>
                            <textarea id="content" placeholder="Contenu complet" rows="8" class="w-full p-3 border rounded"></textarea>
                        </div>

                        <div class="flex gap-2 justify-end">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-100">
                                Annuler
                            </button>
                            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                Sauvegarder
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let currentPassword = '';
        let currentType = 'jobs';
        let currentLang = 'fr';
        let currentData = [];
        let availableCategories = {
            jobs: { fr: [], en: [] },
            news: { fr: [], en: [] }
        };

        // Category to image mapping for news
        const categoryImageMap = {
            // French categories
            'Beach Pro Tour': 'images/beach-pro-tour-hero.webp',
            'Championnats du Monde UCI': 'images/montreal-2026-uci-hero.jpg',
            'Marathon Beneva': 'images/marathon-beneva-hero.jpg',
            'Grands Prix Cyclistes': 'images/grands-prix-cyclistes-hero.jpg',
            'Nouvelles corporatives': 'images/tonic-logo.png',
            
            // English categories
            'UCI World Championships': 'images/montreal-2026-uci-hero.jpg',
            'Beneva Marathon': 'images/marathon-beneva-hero.jpg',
            'Cycling Grand Prix': 'images/grands-prix-cyclistes-hero.jpg'
        };

        // Authentication helpers
        function makeAuthenticatedRequest(url, options = {}) {
            return fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Password': currentPassword,
                    ...options.headers
                }
            });
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            try {
                const response = await fetch(`${API_BASE}/api/cms/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentPassword = password;
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    loadContent();
                } else {
                    errorDiv.textContent = data.message || 'Login failed';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Connection failed';
                errorDiv.classList.remove('hidden');
            }
        });

        // Content type and language handlers
        document.getElementById('contentType').addEventListener('change', (e) => {
            currentType = e.target.value;
            updateUI();
            loadContent();
        });

        document.getElementById('language').addEventListener('change', (e) => {
            currentLang = e.target.value;
            updateUI();
            loadContent();
        });

        function updateUI() {
            const title = currentType === 'jobs' ? 'Emplois' : 'Actualités';
            const lang = currentLang === 'fr' ? 'Français' : 'English';
            document.getElementById('contentTitle').textContent = `${title} - ${lang}`;
            
            // Toggle field visibility
            if (currentType === 'jobs') {
                document.getElementById('jobFields').classList.remove('hidden');
                document.getElementById('newsFields').classList.add('hidden');
            } else {
                document.getElementById('jobFields').classList.add('hidden');
                document.getElementById('newsFields').classList.remove('hidden');
            }
            
            // Update dropdown categories for current type/language
            updateCategoryDropdowns();
        }

        async function loadContent() {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/api/cms/${currentType}?lang=${currentLang}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load content');
                }

                const data = await response.json();
                currentData = data[currentType] || [];
                
                // Extract and store categories
                extractCategories(currentData);
                updateCategoryDropdowns();
                
                displayContent(currentData);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('contentList').innerHTML = '<p class="text-red-500">Erreur de chargement</p>';
            }
        }

        function extractCategories(data) {
            const categories = new Set();
            
            data.forEach(item => {
                if (currentType === 'jobs' && item.department) {
                    categories.add(item.department);
                } else if (currentType === 'news' && item.category) {
                    categories.add(item.category);
                }
            });
            
            // Store categories for current type and language
            availableCategories[currentType][currentLang] = Array.from(categories).sort();
        }

        function updateCategoryDropdowns() {
            const categories = availableCategories[currentType][currentLang];
            
            if (currentType === 'jobs') {
                const select = document.getElementById('department');
                const placeholder = currentLang === 'fr' ? 'Sélectionner un département' : 'Select a department';
                const newOption = currentLang === 'fr' ? '+ Nouveau département' : '+ New department';
                select.innerHTML = `<option value="">${placeholder}</option>` + 
                    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('') +
                    `<option value="NEW_CATEGORY">${newOption}</option>`;
            } else {
                const select = document.getElementById('category');
                const placeholder = currentLang === 'fr' ? 'Sélectionner une catégorie' : 'Select a category';
                const newOption = currentLang === 'fr' ? '+ Nouvelle catégorie' : '+ New category';
                select.innerHTML = `<option value="">${placeholder}</option>` + 
                    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('') +
                    `<option value="NEW_CATEGORY">${newOption}</option>`;
            }
        }

        function displayContent(items) {
            const container = document.getElementById('contentList');
            
            if (!items || items.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun contenu</p>';
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-blue-600">${item.title || ''}</h3>
                            <div class="text-sm text-gray-600 mt-2">
                                ${currentType === 'jobs' 
                                    ? `Département: ${item.department || 'N/A'} | Lieu: ${item.location || 'N/A'}`
                                    : `Date: ${item.date || 'N/A'} | Catégorie: ${item.category || 'N/A'}`
                                }
                            </div>
                            <div class="mt-3 text-gray-700">
                                ${currentType === 'jobs' 
                                    ? (item.description || '').replace(/<[^>]*>/g, '').substring(0, 200) + '...'
                                    : (item.content || item.summary || '').replace(/<[^>]*>/g, '').substring(0, 200) + '...'
                                }
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editItem(${item.id})" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                Éditer
                            </button>
                            <button onclick="deleteItem(${item.id})" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showAddForm() {
            document.getElementById('modalTitle').textContent = 'Ajouter';
            document.getElementById('editForm').reset();
            document.getElementById('itemId').value = '';
            updateUI();
            document.getElementById('editModal').classList.remove('hidden');
        }

        function editItem(id) {
            const item = currentData.find(i => i.id == id);
            if (!item) return;

            document.getElementById('modalTitle').textContent = 'Éditer';
            document.getElementById('itemId').value = id;

            if (currentType === 'jobs') {
                document.getElementById('title').value = item.title || '';
                document.getElementById('department').value = item.department || '';
                document.getElementById('location').value = item.location || '';
                document.getElementById('type').value = item.type || '';
                document.getElementById('salary').value = item.salary || '';
                document.getElementById('description').value = (item.description || '').replace(/<[^>]*>/g, '');
            } else {
                document.getElementById('newsTitle').value = item.title || '';
                document.getElementById('date').value = item.date || '';
                document.getElementById('category').value = item.category || '';
                document.getElementById('image').value = item.image || '';
                document.getElementById('summary').value = item.summary || '';
                document.getElementById('content').value = (item.content || '').replace(/<[^>]*>/g, '');
            }

            updateUI();
            document.getElementById('editModal').classList.remove('hidden');
        }

        // Form submission
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const id = document.getElementById('itemId').value;
                const isNew = !id;
                
                let data = { lang: currentLang };
                
                if (currentType === 'jobs') {
                    data = {
                        ...data,
                        title: document.getElementById('title').value,
                        department: document.getElementById('department').value,
                        location: document.getElementById('location').value,
                        type: document.getElementById('type').value,
                        salary: document.getElementById('salary').value,
                        description: document.getElementById('description').value
                    };
                } else {
                    data = {
                        ...data,
                        title: document.getElementById('newsTitle').value,
                        date: document.getElementById('date').value,
                        category: document.getElementById('category').value,
                        image: document.getElementById('image').value,
                        summary: document.getElementById('summary').value,
                        content: document.getElementById('content').value
                    };
                }

                const url = isNew 
                    ? `${API_BASE}/api/cms/${currentType}` 
                    : `${API_BASE}/api/cms/${currentType}/${id}`;
                
                const response = await makeAuthenticatedRequest(url, {
                    method: isNew ? 'POST' : 'PUT',
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('Save failed');
                }
                
                closeModal();
                await loadContent();
                alert(isNew ? 'Créé avec succès' : 'Modifié avec succès');
            } catch (error) {
                console.error('Save error:', error);
                alert('Erreur de sauvegarde');
            }
        });

        async function deleteItem(id) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cet élément?')) return;

            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/api/cms/${currentType}/${id}?lang=${currentLang}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Delete failed');
                
                loadContent();
                alert('Supprimé avec succès');
            } catch (error) {
                console.error('Delete error:', error);
                alert('Erreur de suppression');
            }
        }

        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        function logout() {
            currentPassword = '';
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginForm').reset();
        }

        // Handle new category selection and auto-assign images
        document.addEventListener('change', function(e) {
            if ((e.target.id === 'department' || e.target.id === 'category') && e.target.value === 'NEW_CATEGORY') {
                const fieldType = e.target.id === 'department' ? 'département' : 'catégorie';
                const fieldTypeEn = e.target.id === 'department' ? 'department' : 'category';
                const prompt = currentLang === 'fr' 
                    ? `Entrez le nom du nouveau ${fieldType}:` 
                    : `Enter the new ${fieldTypeEn} name:`;
                
                const newValue = window.prompt(prompt);
                
                if (newValue && newValue.trim()) {
                    // Add new option to the select
                    const option = document.createElement('option');
                    option.value = newValue.trim();
                    option.textContent = newValue.trim();
                    option.selected = true;
                    
                    // Insert before the "NEW_CATEGORY" option
                    const newCategoryOption = e.target.querySelector('option[value="NEW_CATEGORY"]');
                    e.target.insertBefore(option, newCategoryOption);
                } else {
                    // Reset to empty if cancelled
                    e.target.value = '';
                }
            }
            
            // Auto-assign image when category is selected for news
            if (e.target.id === 'category' && currentType === 'news' && e.target.value && e.target.value !== 'NEW_CATEGORY') {
                const imageField = document.getElementById('image');
                const associatedImage = categoryImageMap[e.target.value];
                
                if (associatedImage && imageField) {
                    imageField.value = associatedImage;
                }
            }
        });

        // Initialize
        updateUI();
    </script>
</body>
</html>