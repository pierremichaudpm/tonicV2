// REPLACE THE showContentPreview FUNCTION
function showContentPreview(fieldId, content) {
    console.log('👁️ Showing preview for field:', fieldId, 'Content length:', content.length);
    
    const previewDiv = document.getElementById(fieldId + 'Preview');
    const previewText = document.getElementById(fieldId + 'PreviewText');
    
    if (previewDiv && previewText && content) {
        // Show HTML preview (preserves links and formatting)
        const shortPreview = content.length > 300 ? content.substring(0, 300) + '...' : content;
        previewText.innerHTML = shortPreview; // Use innerHTML to show links and formatting
        previewDiv.style.display = 'block';
        
        console.log('✅ Preview updated successfully');
    } else {
        console.log('⚠️ Preview elements not found or no content');
    }
}

// UPDATE THE editItem FUNCTION TO CLEAR PROCESSED CONTENT
function editItem(id) {
    const item = currentData.find(i => i.id == id);
    if (!item) return;

    document.getElementById('modalTitle').textContent = 'Éditer';
    document.getElementById('itemId').value = id;

    if (currentType === 'jobs') {
        document.getElementById('title').value = item.title || '';
        document.getElementById('department').value = item.department || '';
        document.getElementById('location').value = item.location || item.lieu || '';
        document.getElementById('type').value = item.type || '';
        document.getElementById('salary').value = item.salary || item.salaire || '';
        document.getElementById('datePosted').value = item.datePosted || '';
        document.getElementById('deadline').value = item.deadline || '';
        document.getElementById('summary').value = item.summary || '';
        
        // Convert HTML to plain text for editing
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = item.description || '';
        const plainText = tempDiv.textContent || tempDiv.innerText || '';
        const descField = document.getElementById('description');
        descField.value = plainText;
        
        // Clear any stored processed content and store the original HTML
        descField.removeAttribute('data-processed-content');
        if (item.description) {
            descField.setAttribute('data-processed-content', item.description);
        }
    } else {
        document.getElementById('newsTitle').value = item.title || '';
        document.getElementById('date').value = item.date || '';
        document.getElementById('category').value = item.category || '';
        document.getElementById('newsSummary').value = item.summary || '';
        
        // Convert HTML to plain text for editing
        const tempDiv2 = document.createElement('div');
        tempDiv2.innerHTML = item.content || '';
        const plainText = tempDiv2.textContent || tempDiv2.innerText || '';
        const contentField = document.getElementById('content');
        contentField.value = plainText;
        
        // Clear any stored processed content and store the original HTML
        contentField.removeAttribute('data-processed-content');
        if (item.content) {
            contentField.setAttribute('data-processed-content', item.content);
        }
    }

    toggleFieldVisibility();
    document.getElementById('editModal').classList.remove('hidden');
}

// UPDATE THE showAddForm FUNCTION TO CLEAR PROCESSED CONTENT
function showAddForm() {
    document.getElementById('modalTitle').textContent = 'Ajouter';
    document.getElementById('editForm').reset();
    document.getElementById('itemId').value = '';
    
    // Clear any stored processed content
    const descField = document.getElementById('description');
    const contentField = document.getElementById('content');
    if (descField) descField.removeAttribute('data-processed-content');
    if (contentField) contentField.removeAttribute('data-processed-content');
    
    toggleFieldVisibility();
    document.getElementById('editModal').classList.remove('hidden');
}